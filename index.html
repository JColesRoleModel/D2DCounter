<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#0f172a" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="D2D Tracker" />
    
    <title>D2D Resources | Future Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiRDJEIFJlc291cmNlcyIs" />

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        d2d: {
                            navy: '#0f172a',
                            gold: '#f59e0b',
                            goldLight: '#fbbf24',
                            dark: '#020617',
                            glass: 'rgba(15, 23, 42, 0.6)',
                            glassBorder: 'rgba(255, 255, 255, 0.08)',
                        }
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Styles -->
    <style>
        :root {
            --bg-color: #000;
            --text-color: #f1f5f9;
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-card-bg: rgba(30, 41, 59, 0.4);
            --glass-border: rgba(255, 255, 255, 0.08);
            --blob-color-1: #f59e0b;
            --blob-color-2: #1e3a8a;
            --blob-color-3: #4c1d95;
            --header-height: 80px;
            --footer-height: 80px;
        }

        /* Light Mode Variables */
        body.light-mode {
            --bg-color: #f0f9ff;
            --text-color: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-card-bg: rgba(255, 255, 255, 0.6);
            --glass-border: rgba(0, 0, 0, 0.05);
            --blob-color-1: #fbbf24;
            --blob-color-2: #60a5fa;
            --blob-color-3: #a78bfa;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Prevent body scroll, handle in main */
            transition: background-color 0.5s ease, color 0.5s ease;
            -webkit-tap-highlight-color: transparent;
            height: 100vh;
            width: 100vw;
        }
        
        /* Animated Background */
        .bg-ambient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: var(--bg-color);
            overflow: hidden;
            transition: background 0.5s ease;
        }
        
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: blob 20s infinite alternate;
        }
        .orb-1 { top: 10%; left: 20%; width: 300px; height: 300px; background: var(--blob-color-1); animation-delay: 0s; }
        .orb-2 { top: 60%; left: 70%; width: 400px; height: 400px; background: var(--blob-color-2); animation-delay: -5s; }
        .orb-3 { top: 40%; left: 40%; width: 200px; height: 200px; background: var(--blob-color-3); animation-delay: -10s; }

        /* Glassmorphism Utils */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            transition: background 0.3s, border 0.3s;
        }
        
        .glass-card {
            background: var(--glass-card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            transition: background 0.3s, border 0.3s;
        }

        /* Light mode specific text overrides */
        body.light-mode .text-gray-400 { color: #64748b; }
        body.light-mode .text-gray-300 { color: #475569; }
        body.light-mode .text-gray-500 { color: #94a3b8; }
        body.light-mode .text-white { color: #0f172a; }

        /* Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Button active press effect */
        .btn-press:active { transform: scale(0.96); }
        
        /* Safe Area for iPhones */
        .safe-area-pb {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* Leaflet Overrides */
        .leaflet-container {
            font-family: inherit;
            z-index: 10;
        }
        .leaflet-control-attribution {
            display: none;
        }
        .custom-div-icon {
            background: transparent;
            border: none;
        }
        /* New Pin Styling */
        .marker-pin-enhanced {
            width: 44px;
            height: 44px;
            border-radius: 50% 50% 50% 0;
            background: #fff;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -22px 0 0 -22px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            transition: transform 0.2s;
        }
        .marker-pin-enhanced svg {
            transform: rotate(45deg); /* Counter rotate icon */
            width: 22px;
            height: 22px;
            color: white;
        }
        .marker-pin-enhanced:active {
            transform: rotate(-45deg) scale(1.1);
        }
        
        /* Map Popup Styling */
        .leaflet-popup-content-wrapper {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            padding: 0;
        }
        .leaflet-popup-content {
            margin: 10px;
        }
        .leaflet-popup-tip {
            background: rgba(15, 23, 42, 0.95);
        }
    </style>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
            "recharts": "https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0",
            "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
            "react/": "https://esm.sh/react@^19.2.3/",
            "canvas-confetti": "https://esm.sh/canvas-confetti@1.9.2"
        }
    }
    </script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>

    <!-- Background Elements -->
    <div class="bg-ambient">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            DoorOpen, User, MessageCircle, ArrowRight, Calendar, DollarSign, 
            CheckCircle, XCircle, Zap, Sun, Moon, Home, Phone, Mail, TrendingUp, 
            Award, Smile, Frown, ThumbsUp, ThumbsDown, ClipboardList, Target, 
            LayoutDashboard, BarChart2, Settings, Key, Minus, Plus, Save, 
            RefreshCw, Trash2, PlusCircle, X, AlertTriangle, Check, Trophy, Flame, Download, Map as MapIcon,
            MapPin, List, Database, PenSquare, Crosshair
        } from 'lucide-react';
        import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, PieChart, Pie } from 'recharts';
        import confetti from 'canvas-confetti';

        // --- RAW SVG STRINGS FOR LEAFLET ICONS ---
        const RAW_ICONS = {
            'door': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M13 4h3a2 2 0 0 1 2 2v14"/><path d="M2 20h3"/><path d="M13 20h9"/><path d="M10 12v.01"/><path d="M13 4.562v16.157a1 1 0 0 1-1.242.97L5 20V5.562a2 2 0 0 1 1.515-1.94l4-1A2 2 0 0 1 13 4.561Z"/></svg>',
            'user': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
            'message-circle': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"/></svg>',
            'arrow-right': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>',
            'calendar': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>',
            'default': '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="M22 4 12 14.01l-3-3"/></svg>'
        };

        const getIconSvg = (iconName) => {
            return RAW_ICONS[iconName] || RAW_ICONS['default'];
        };

        // --- CONSTANTS ---
        const DEFAULT_METRICS = [
            { id: 'doors', label: 'Doors', icon: 'door', color: 'text-blue-400', isGoal: false, isInput: true },
            { id: 'dms', label: 'DMs Contacted', icon: 'user', color: 'text-indigo-400', isGoal: false, isInput: false },
            { id: 'pres', label: 'Door Presentation Complete', icon: 'message-circle', color: 'text-purple-400', isGoal: false, isInput: false },
            { id: 'trans', label: 'Transition Attempts', icon: 'arrow-right', color: 'text-pink-400', isGoal: false, isInput: false },
            { id: 'appt', label: 'Sets', icon: 'calendar', color: 'text-d2d-gold', isGoal: true, isInput: false },
        ];

        const ICON_MAP = {
            'door': <DoorOpen size={20} />,
            'user': <User size={20} />,
            'message-circle': <MessageCircle size={20} />,
            'arrow-right': <ArrowRight size={20} />,
            'calendar': <Calendar size={20} />,
            'dollar-sign': <DollarSign size={20} />,
            'check-circle': <CheckCircle size={20} />,
            'x-circle': <XCircle size={20} />,
            'zap': <Zap size={20} />,
            'sun': <Sun size={20} />,
            'home': <Home size={20} />,
            'phone': <Phone size={20} />,
            'mail': <Mail size={20} />,
            'trending-up': <TrendingUp size={20} />,
            'award': <Award size={20} />,
            'smile': <Smile size={20} />,
            'frown': <Frown size={20} />,
            'thumbs-up': <ThumbsUp size={20} />,
            'thumbs-down': <ThumbsDown size={20} />,
            'clipboard': <ClipboardList size={20} />,
            'target': <Target size={20} />
        };

        const INDUSTRY_AVERAGE_RATIO = 50;
        const STORAGE_KEY = 'd2d_resources_data_v2'; 
        const MAX_STORAGE_BYTES = 4500000; // ~4.5MB safe limit

        // --- SERVICES ---
        const getInitialState = () => {
            try {
                let stored = localStorage.getItem(STORAGE_KEY);
                if (!stored) stored = localStorage.getItem('d2d_resources_data_v1');

                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (!parsed.metrics || parsed.metrics.length === 0) {
                        parsed.metrics = DEFAULT_METRICS;
                    }
                    if (!parsed.theme) parsed.theme = 'dark'; 
                    return parsed;
                }
            } catch (e) {
                console.error("Failed to load state", e);
            }
            return { metrics: DEFAULT_METRICS, logs: [], theme: 'dark' };
        };

        const saveState = (state) => {
            try {
                const stringified = JSON.stringify(state);
                localStorage.setItem(STORAGE_KEY, stringified);
                return stringified.length; 
            } catch (e) {
                console.error("Failed to save state", e);
                return -1; 
            }
        };

        const getColorHex = (tailwindClass) => {
            if (tailwindClass.includes('blue')) return '#60a5fa';
            if (tailwindClass.includes('indigo')) return '#818cf8';
            if (tailwindClass.includes('purple')) return '#c084fc';
            if (tailwindClass.includes('pink')) return '#f472b6';
            if (tailwindClass.includes('gold') || tailwindClass.includes('yellow')) return '#f59e0b';
            if (tailwindClass.includes('green')) return '#4ade80';
            if (tailwindClass.includes('red')) return '#f87171';
            return '#94a3b8';
        };

        // --- HELPER FUNCTIONS ---
        const getStartOfDay = (date) => {
            const d = new Date(date);
            d.setHours(0,0,0,0);
            return d;
        };

        const getStartOfWeek = (date) => {
            const d = new Date(date);
            const day = d.getDay(); 
            const diff = d.getDate() - day;
            d.setDate(diff);
            d.setHours(0,0,0,0);
            return d;
        };

        const getStartOfMonth = (date) => {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        };

        const getStartOfQuarter = (date) => {
            const q = Math.floor(date.getMonth() / 3);
            return new Date(date.getFullYear(), q * 3, 1);
        };

        const getStartOfYear = (date) => {
            return new Date(date.getFullYear(), 0, 1);
        };

        const makeSingular = (text) => {
            if (!text) return text;
            if (text.toLowerCase().endsWith('s')) return text.slice(0, -1);
            return text;
        };

        const makePlural = (text) => {
            if (!text) return text;
            if (text.toLowerCase().endsWith('s')) return text; 
            return text + 's';
        };

        // --- COMPONENTS ---

        const Modal = ({ isOpen, onClose, onConfirm, title, message, type = 'confirm' }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-200 p-4">
                    <div className="glass-panel w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-d2d-gold/20 scale-100 animate-in zoom-in-95 duration-200">
                        <div className="flex items-start gap-4 mb-4">
                            <div className={`p-3 rounded-full ${type === 'confirm' || type === 'alert' ? 'bg-d2d-gold/10 text-d2d-gold' : 'bg-blue-500/10 text-blue-400'}`}>
                                {type === 'confirm' ? <AlertTriangle size={24} /> : type === 'alert' ? <Database size={24} /> : <CheckCircle size={24} />}
                            </div>
                            <div>
                                <h3 className="text-xl font-bold text-white mb-1">{title}</h3>
                                <p className="text-gray-400 text-sm leading-relaxed">{message}</p>
                            </div>
                        </div>
                        
                        <div className="flex gap-3 justify-end mt-6">
                            {(type === 'confirm' || type === 'prune') && (
                                <button 
                                    onClick={onClose}
                                    className="px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/10 transition font-medium text-sm"
                                >
                                    Cancel
                                </button>
                            )}
                            <button 
                                onClick={() => { if (onConfirm) onConfirm(); onClose(); }}
                                className="px-6 py-3 rounded-xl bg-d2d-gold text-black font-bold shadow-[0_0_15px_rgba(245,158,11,0.3)] hover:bg-yellow-400 transition text-sm active:scale-95"
                            >
                                {type === 'prune' ? 'Clean Up' : type === 'confirm' ? 'Confirm' : 'Got it'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- GLOBAL HEADER ---
        const TopBar = ({ onHome }) => {
            return (
                <div className="fixed top-0 left-0 right-0 z-[60] h-[80px] glass-panel border-b border-d2d-glassBorder flex items-center justify-between px-4 safe-area-top backdrop-blur-xl shadow-lg">
                    {/* Left: Brand */}
                    <div className="flex items-center">
                        <h1 className="text-lg font-black text-white tracking-widest uppercase" style={{textShadow: '0 0 10px rgba(0,0,0,0.5)'}}>
                            D2D Resources
                        </h1>
                    </div>

                    {/* Center: Key Icon */}
                    <div className="absolute left-1/2 -translate-x-1/2 bg-d2d-gold/10 p-2 rounded-full border border-d2d-gold/30 shadow-[0_0_15px_rgba(245,158,11,0.2)]">
                        <Key className="text-d2d-gold" size={24} />
                    </div>

                    {/* Right: Quote & Home */}
                    <div className="flex items-center gap-3">
                        <p className="hidden sm:block text-[8px] text-gray-400 italic text-right leading-tight max-w-[120px]">
                            Putting the keys to <span className="text-d2d-gold font-bold">YOUR OWN</span> success in your own hands
                        </p>
                        <button 
                            onClick={onHome}
                            className="p-2 bg-white/5 rounded-full hover:bg-white/10 text-white border border-white/10 transition-colors"
                        >
                            <Home size={20} />
                        </button>
                    </div>
                </div>
            );
        };

        // --- MAP VIEW COMPONENT ---
        const MapView = ({ state, onLog, onUpdateLog, onDeleteLog, theme, isVisible }) => {
            const mapRef = useRef(null);
            const mapContainerRef = useRef(null);
            const [drawerOpen, setDrawerOpen] = useState(false);
            const [selectedLocation, setSelectedLocation] = useState(null);
            const [editingLogId, setEditingLogId] = useState(null); // ID of log being edited, null if new
            const [isAddMode, setIsAddMode] = useState(false);
            const [deleteConfirm, setDeleteConfirm] = useState(null); // ID of log to delete

            // Form State
            const [formData, setFormData] = useState({
                firstName: '',
                lastName: '',
                phone: '',
                note: '',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                metricId: null
            });

            // Handle Resize / Re-render fixes when view becomes visible
            useEffect(() => {
                if (isVisible && mapRef.current) {
                    setTimeout(() => {
                        mapRef.current.invalidateSize();
                    }, 100);
                }
            }, [isVisible]);

            // Initialize Map
            useEffect(() => {
                if (!mapContainerRef.current) return;
                if (mapRef.current) return; // Already initialized

                const lastLogWithLoc = [...state.logs].reverse().find(l => l.lat && l.lng);
                const initialView = lastLogWithLoc ? [lastLogWithLoc.lat, lastLogWithLoc.lng] : [39.8283, -98.5795];
                const initialZoom = lastLogWithLoc ? 16 : 4;

                const map = L.map(mapContainerRef.current, {
                    zoomControl: false,
                    attributionControl: false
                }).setView(initialView, initialZoom);

                // Layers
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }).addTo(map);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }).addTo(map);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 }).addTo(map);

                // Handle Map Click (Only in Add Mode)
                map.on('click', (e) => {
                    // We need to access current isAddMode value. Since this closure is stale, we check the state setter or use ref in larger apps. 
                    // For single file simplicity, we'll cheat a bit by relying on a data attribute or global, BUT properly in React we should use a ref for the active mode.
                    // Instead, let's use the click handler logic dynamically based on state via another useEffect or keep it simple:
                    // Since standard Leaflet events don't see updated React state easily without Re-refs, we'll set up the listener in a Effect that depends on isAddMode.
                });

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        map.flyTo([pos.coords.latitude, pos.coords.longitude], 18);
                    });
                }

                mapRef.current = map;

                return () => {
                    if (mapRef.current) {
                        mapRef.current.remove();
                        mapRef.current = null;
                    }
                };
            }, []);

            // Handle Add Mode Click Listener
            useEffect(() => {
                if(!mapRef.current) return;

                // Remove previous click handlers to update closure
                mapRef.current.off('click');

                mapRef.current.on('click', (e) => {
                    if (isAddMode) {
                        setEditingLogId(null); 
                        setSelectedLocation(e.latlng);
                        setFormData({
                            firstName: '',
                            lastName: '',
                            phone: '',
                            note: '',
                            date: new Date().toISOString().split('T')[0],
                            time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                            metricId: null
                        });
                        setIsAddMode(false); // Auto turn off add mode after placing? Or keep on? Let's turn off for safety.
                    }
                });
            }, [isAddMode]);

            // Update Markers
            useEffect(() => {
                if (!mapRef.current) return;
                
                mapRef.current.eachLayer((layer) => {
                    if (layer instanceof L.Marker) {
                        mapRef.current.removeLayer(layer);
                    }
                });

                state.logs.forEach(log => {
                    if (log.lat && log.lng && log.value > 0) {
                        const metric = state.metrics.find(m => m.metricId === log.metricId) || state.metrics.find(m => m.id === log.metricId);
                        if (!metric) return;
                        
                        const color = getColorHex(metric.color);
                        const iconSvg = getIconSvg(metric.icon);
                        
                        // Enhanced Pin Styling with Icon
                        const customIcon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div class="marker-pin-enhanced" style="background-color: ${color}; border-color: white;">${iconSvg}</div>`,
                            iconSize: [48, 48], // Increased size for mobile
                            iconAnchor: [24, 48],
                            popupAnchor: [0, -48]
                        });

                        const marker = L.marker([log.lat, log.lng], { 
                            icon: customIcon,
                            draggable: true, 
                            autoPan: true,
                            zIndexOffset: 1000 // Ensure markers are above everything
                        }).addTo(mapRef.current);

                        // Click to Edit
                        marker.on('click', (e) => {
                            L.DomEvent.stopPropagation(e); // Don't trigger map click
                            setEditingLogId(log.id);
                            setSelectedLocation({ lat: log.lat, lng: log.lng });
                            
                            // Populate form
                            const dateObj = new Date(log.timestamp);
                            setFormData({
                                firstName: log.meta?.firstName || '',
                                lastName: log.meta?.lastName || '',
                                phone: log.meta?.phone || '',
                                note: log.meta?.note || '',
                                date: log.meta?.manualDate || dateObj.toISOString().split('T')[0],
                                time: log.meta?.manualTime || dateObj.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                                metricId: log.metricId
                            });
                        });

                        // Handle Drag End (Relocation)
                        marker.on('dragend', function(event) {
                            const marker = event.target;
                            const position = marker.getLatLng();
                            onUpdateLog(log.id, { lat: position.lat, lng: position.lng });
                        });
                    }
                });
            }, [state.logs, state.metrics, onUpdateLog]);

            const handleSaveLog = () => {
                if (selectedLocation && formData.metricId) {
                    // We only set creation timestamp for new logs. 
                    // Edits preserve the original timestamp.
                    const timestamp = editingLogId ? undefined : Date.now();

                    const meta = {
                        firstName: formData.firstName,
                        lastName: formData.lastName,
                        phone: formData.phone,
                        note: formData.note,
                        manualDate: formData.date,
                        manualTime: formData.time
                    };

                    if (editingLogId) {
                        // Update existing (timestamp not passed = preserved)
                        const changes = {
                            metricId: formData.metricId,
                            meta: meta,
                            lat: selectedLocation.lat,
                            lng: selectedLocation.lng
                        };
                        if (timestamp) changes.timestamp = timestamp;
                        onUpdateLog(editingLogId, changes);
                    } else {
                        // Create new
                        onLog(formData.metricId, 1, { lat: selectedLocation.lat, lng: selectedLocation.lng }, meta, timestamp);
                    }
                    setSelectedLocation(null);
                    setEditingLogId(null);
                }
            };

            const handleExportCSV = () => {
                // CSV Header
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Type,Value,Date,Time,Lat,Lng,First Name,Last Name,Phone,Note\n";

                state.logs.forEach(log => {
                    const metric = state.metrics.find(m => m.id === log.metricId);
                    if (!metric) return;
                    
                    const dateObj = new Date(log.timestamp);
                    const date = dateObj.toLocaleDateString();
                    const time = dateObj.toLocaleTimeString();
                    const fname = log.meta?.firstName || "";
                    const lname = log.meta?.lastName || "";
                    const phone = log.meta?.phone || "";
                    const note = (log.meta?.note || "").replace(/,/g, " "); // Basic escape commas

                    csvContent += `${metric.label},${log.value},${date},${time},${log.lat || ""},${log.lng || ""},${fname},${lname},${phone},${note}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `d2d_export_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                link.remove();
            };

            const sortedLogs = [...state.logs].sort((a,b) => b.timestamp - a.timestamp).slice(0, 50);

            return (
                <div className="relative w-full h-full bg-gray-900">
                    <div ref={mapContainerRef} className="absolute inset-0 z-0" />
                    
                    {/* Add Mode Indicator Overlay */}
                    {isAddMode && (
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 z-[50] bg-d2d-gold text-black px-4 py-2 rounded-full shadow-xl font-bold text-sm animate-bounce pointer-events-none">
                            Tap Map to Drop Pin
                        </div>
                    )}

                    {/* Manual Drop/Edit Modal - CENTERED */}
                    {selectedLocation && (
                        <div className="absolute inset-0 z-[70] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
                            <div className="bg-slate-900 border border-white/10 w-full max-w-sm rounded-2xl p-6 shadow-2xl max-h-[85vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-white font-bold text-lg">{editingLogId ? 'Edit Log Details' : 'Log New Action'}</h3>
                                    <div className="flex gap-2">
                                        {editingLogId && (
                                            <button 
                                                onClick={() => setDeleteConfirm(editingLogId)}
                                                className="p-2 bg-red-500/10 text-red-400 rounded-full hover:bg-red-500/20 transition-colors"
                                            >
                                                <Trash2 size={20}/>
                                            </button>
                                        )}
                                        <button onClick={() => setSelectedLocation(null)} className="p-2 bg-white/5 rounded-full text-white"><X size={20}/></button>
                                    </div>
                                </div>
                                
                                <div className="space-y-3 mb-6">
                                    {/* Metric Selection */}
                                    <div className="grid grid-cols-5 gap-2 mb-4">
                                        {state.metrics.map(m => (
                                            <button 
                                                key={m.id}
                                                onClick={() => setFormData(prev => ({ ...prev, metricId: m.id }))}
                                                className={`flex flex-col items-center justify-center p-2 rounded-xl border transition-all ${
                                                    formData.metricId === m.id 
                                                    ? `bg-white/10 border-${m.color.split('-')[1]}-400 ring-1 ring-${m.color.split('-')[1]}-400` 
                                                    : 'bg-white/5 border-transparent opacity-60 hover:opacity-100'
                                                }`}
                                            >
                                                <div className={`${m.color}`}>{ICON_MAP[m.icon]}</div>
                                            </button>
                                        ))}
                                    </div>

                                    {/* Row 1: First/Last Name */}
                                    <div className="flex gap-3">
                                        <input 
                                            type="text" 
                                            placeholder="First Name"
                                            value={formData.firstName}
                                            onChange={e => setFormData({...formData, firstName: e.target.value})}
                                            className="w-1/2 bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-d2d-gold focus:outline-none"
                                        />
                                        <input 
                                            type="text" 
                                            placeholder="Last Name"
                                            value={formData.lastName}
                                            onChange={e => setFormData({...formData, lastName: e.target.value})}
                                            className="w-1/2 bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-d2d-gold focus:outline-none"
                                        />
                                    </div>

                                    {/* Row 2: Phone */}
                                    <input 
                                        type="tel" 
                                        placeholder="Phone Number"
                                        value={formData.phone}
                                        onChange={e => setFormData({...formData, phone: e.target.value})}
                                        className="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-d2d-gold focus:outline-none"
                                    />

                                    {/* Row 3: Note */}
                                    <textarea 
                                        placeholder="Note / Appt. Reminder Section"
                                        rows="3"
                                        value={formData.note}
                                        onChange={e => setFormData({...formData, note: e.target.value})}
                                        className="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-d2d-gold focus:outline-none resize-none"
                                    ></textarea>

                                    {/* Row 4: Date/Time */}
                                    <div className="flex gap-3">
                                        <input 
                                            type="time" 
                                            value={formData.time}
                                            onChange={e => setFormData({...formData, time: e.target.value})}
                                            className="w-1/2 bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-d2d-gold focus:outline-none"
                                        />
                                        <input 
                                            type="date" 
                                            value={formData.date}
                                            onChange={e => setFormData({...formData, date: e.target.value})}
                                            className="w-1/2 bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:border-d2d-gold focus:outline-none"
                                        />
                                    </div>
                                </div>

                                <button 
                                    onClick={handleSaveLog}
                                    disabled={!formData.metricId}
                                    className={`w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all ${
                                        formData.metricId 
                                        ? 'bg-d2d-gold text-black hover:bg-yellow-400' 
                                        : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    {editingLogId ? 'Update Log' : 'Save Log'}
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Floating Controls Container (Bottom Right) - Moved UP above footer */}
                    <div className="absolute bottom-[100px] right-4 z-[40] flex flex-col gap-3">
                        {/* Add Mode Toggle */}
                        <button 
                            onClick={() => setIsAddMode(!isAddMode)}
                            className={`p-4 rounded-full shadow-lg border border-white/20 transition-all active:scale-95 ${isAddMode ? 'bg-d2d-gold text-black rotate-45' : 'bg-blue-600 text-white'}`}
                        >
                            <Plus size={24} strokeWidth={3} />
                        </button>

                        {/* List/History */}
                        <button 
                            onClick={() => setDrawerOpen(true)}
                            className="bg-d2d-navy/90 text-d2d-gold p-4 rounded-full shadow-lg border border-d2d-gold/30 hover:scale-110 transition-transform active:scale-95"
                        >
                            <List size={24} />
                        </button>
                    </div>

                    {/* Location Button (Bottom Left) - Moved UP above footer */}
                    <div className="absolute bottom-[100px] left-4 z-[40]">
                         <button 
                            onClick={() => {
                                if (navigator.geolocation && mapRef.current) {
                                    navigator.geolocation.getCurrentPosition(pos => {
                                        mapRef.current.flyTo([pos.coords.latitude, pos.coords.longitude], 18);
                                    });
                                }
                            }}
                            className="bg-white/90 text-black p-4 rounded-full shadow-lg hover:bg-white transition-colors active:scale-95"
                        >
                            <Crosshair size={24} />
                        </button>
                    </div>

                    {/* History Drawer */}
                    <div className={`absolute inset-x-0 bottom-0 z-[45] bg-slate-900/95 backdrop-blur-xl border-t border-d2d-gold/20 rounded-t-3xl transition-transform duration-300 ease-out transform ${drawerOpen ? 'translate-y-0' : 'translate-y-full'}`} style={{ height: '70vh', paddingBottom: '80px' }}>
                        <div className="w-12 h-1.5 bg-gray-600 rounded-full mx-auto mt-3 mb-2 opacity-50" onClick={() => setDrawerOpen(false)}></div>
                        <div className="p-6 h-full flex flex-col">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-bold text-white flex items-center gap-2">
                                    <List className="text-d2d-gold"/> Activity Log
                                </h2>
                                <div className="flex gap-3">
                                    <button onClick={handleExportCSV} className="text-blue-400 font-bold text-xs flex items-center gap-1 bg-blue-500/10 px-3 py-1 rounded-full">
                                        <Download size={14}/> CSV
                                    </button>
                                    <button onClick={() => setDrawerOpen(false)} className="text-gray-400"><X size={24}/></button>
                                </div>
                            </div>
                            <div className="overflow-y-auto flex-1 space-y-3 no-scrollbar pb-12">
                                {sortedLogs.length === 0 ? (
                                    <p className="text-center text-gray-500 py-10">No activity recorded yet.</p>
                                ) : (
                                    sortedLogs.map(log => {
                                        const metric = state.metrics.find(m => m.id === log.metricId);
                                        if(!metric) return null;
                                        return (
                                            <div key={log.id} className="bg-white/5 p-3 rounded-xl border border-white/5">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex items-start gap-3">
                                                        <div className={`p-2 rounded-lg bg-black/20 ${metric.color}`}>
                                                            {ICON_MAP[metric.icon]}
                                                        </div>
                                                        <div>
                                                            <div className="font-bold text-gray-200 text-sm">{metric.label}</div>
                                                            <div className="text-[10px] text-gray-500 font-mono">
                                                                Logged: {new Date(log.timestamp).toLocaleTimeString()} â€¢ {new Date(log.timestamp).toLocaleDateString()}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        {log.lat && (
                                                            <button 
                                                                onClick={() => {
                                                                    if(mapRef.current) {
                                                                        mapRef.current.flyTo([log.lat, log.lng], 18);
                                                                        setDrawerOpen(false);
                                                                    }
                                                                }}
                                                                className="p-2 text-d2d-gold hover:text-white bg-white/5 rounded-lg"
                                                            >
                                                                <MapPin size={16} />
                                                            </button>
                                                        )}
                                                        <button 
                                                            onClick={() => {
                                                                setEditingLogId(log.id);
                                                                setSelectedLocation({ lat: log.lat || 0, lng: log.lng || 0 });
                                                                const dateObj = new Date(log.timestamp);
                                                                setFormData({
                                                                    firstName: log.meta?.firstName || '',
                                                                    lastName: log.meta?.lastName || '',
                                                                    phone: log.meta?.phone || '',
                                                                    note: log.meta?.note || '',
                                                                    date: log.meta?.manualDate || dateObj.toISOString().split('T')[0],
                                                                    time: log.meta?.manualTime || dateObj.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' }),
                                                                    metricId: log.metricId
                                                                });
                                                                setDrawerOpen(false);
                                                            }}
                                                            className="p-2 text-gray-400 hover:text-white bg-white/5 rounded-lg"
                                                        >
                                                            <PenSquare size={16} />
                                                        </button>
                                                        <button 
                                                            onClick={() => setDeleteConfirm(log.id)}
                                                            className="p-2 text-red-400 hover:text-white bg-white/5 rounded-lg"
                                                        >
                                                            <Trash2 size={16} />
                                                        </button>
                                                    </div>
                                                </div>
                                                {log.meta && (log.meta.note || log.meta.firstName) && (
                                                    <div className="mt-2 pt-2 border-t border-white/5 text-xs text-gray-400">
                                                        {log.meta.firstName && <span className="font-bold text-white block">{log.meta.firstName} {log.meta.lastName}</span>}
                                                        {log.meta.phone && <span className="block text-blue-400">{log.meta.phone}</span>}
                                                        {log.meta.note && <p className="mt-1 italic">"{log.meta.note}"</p>}
                                                    </div>
                                                )}
                                            </div>
                                        )
                                    })
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Delete Confirmation Modal */}
                    <Modal 
                        isOpen={!!deleteConfirm} 
                        title="Delete Log?" 
                        message="Are you sure you want to delete this activity log? This cannot be undone." 
                        type="confirm"
                        onClose={() => setDeleteConfirm(null)}
                        onConfirm={() => {
                            onDeleteLog(deleteConfirm);
                            setDeleteConfirm(null);
                            // If we were editing this log, close the edit modal too
                            if (editingLogId === deleteConfirm) {
                                setSelectedLocation(null);
                                setEditingLogId(null);
                            }
                        }}
                    />
                </div>
            );
        };

        const DashboardHeader = ({ state }) => {
            const { metrics, logs } = state;
            const inputMetric = metrics.find(m => m.isInput) || metrics[0] || { label: '?', id: '?' };
            const goalMetric = metrics.find(m => m.isGoal) || metrics[metrics.length - 1] || { label: '?', id: '?' };

            const stats = useMemo(() => {
                const totalInputsAllTime = logs.filter(l => l.metricId === inputMetric.id).reduce((acc, curr) => acc + curr.value, 0);
                const totalGoalsAllTime = logs.filter(l => l.metricId === goalMetric.id).reduce((acc, curr) => acc + curr.value, 0);
                
                const rawRatio = totalGoalsAllTime > 0 ? totalInputsAllTime / totalGoalsAllTime : INDUSTRY_AVERAGE_RATIO;
                const ratio = Math.max(1, Math.round(rawRatio));

                const sortedLogs = [...logs].sort((a, b) => b.timestamp - a.timestamp);
                const lastGoalIndex = sortedLogs.findIndex(l => l.metricId === goalMetric.id && l.value > 0);
                
                const logsSinceGoal = lastGoalIndex === -1 ? sortedLogs : sortedLogs.slice(0, lastGoalIndex);
                
                const currentStreakInputs = logsSinceGoal
                    .filter(l => l.metricId === inputMetric.id)
                    .reduce((acc, curr) => acc + curr.value, 0);

                const remaining = Math.max(0, ratio - currentStreakInputs);
                const progressPercent = Math.min(100, (currentStreakInputs / ratio) * 100);

                return { ratio, currentStreakInputs, remaining, progressPercent, totalGoalsAllTime };
            }, [logs, inputMetric.id, goalMetric.id]);

            const formattedInputLabel = stats.remaining === 1 ? makeSingular(inputMetric.label) : makePlural(inputMetric.label);
            const formattedGoalLabel = makeSingular(goalMetric.label);

            const isLightMode = state.theme === 'light';
            const cardClass = isLightMode 
                ? "bg-slate-900 border border-slate-800 shadow-xl" 
                : "bg-white border border-white/20 shadow-xl";
            const mainTextColor = isLightMode ? "text-white" : "text-slate-900";
            const subTextColor = isLightMode ? "text-slate-400" : "text-slate-500";
            const labelColor = isLightMode ? "text-slate-300" : "text-slate-600";
            const trackBg = isLightMode ? "bg-white/10" : "bg-slate-200";

            return (
                <div className="w-full glass-panel border-b border-d2d-glassBorder p-6 shadow-2xl backdrop-blur-xl transition-colors duration-500">
                    <div className={`rounded-2xl p-6 relative overflow-hidden group transition-all duration-500 ${cardClass}`}>
                        <div className={`absolute top-0 right-0 w-32 h-32 bg-d2d-gold/20 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none ${isLightMode ? 'opacity-30' : 'opacity-60'}`}></div>
                        
                        <div className="flex flex-col items-center justify-center mb-6 relative z-10">
                            <span className={`text-[10px] font-bold uppercase tracking-widest mb-1 ${labelColor}`}>
                                {formattedInputLabel.toUpperCase()} UNTIL NEXT {formattedGoalLabel.toUpperCase()}
                            </span>
                            
                            <div className="text-center">
                                {stats.remaining <= 0 ? (
                                    <span className="text-2xl font-black text-d2d-gold tracking-tight animate-pulse">
                                        ANY DOOR NOW!<br/>
                                        <span className={`text-sm font-bold ${mainTextColor}`}>YOU'VE GOT THIS!</span>
                                    </span>
                                ) : (
                                    <span className={`text-6xl font-black tracking-tighter ${mainTextColor}`}>
                                        {stats.remaining}
                                    </span>
                                )}
                            </div>
                        </div>
                        
                        <div className={`h-3 w-full rounded-full overflow-hidden relative shadow-inner ${trackBg}`}>
                            <div 
                                className="h-full bg-gradient-to-r from-d2d-gold to-yellow-400 transition-all duration-700 ease-out relative shadow-sm"
                                style={{ width: `${stats.progressPercent}%` }}
                            >
                                <div className="absolute inset-0 bg-white/30 animate-pulse"></div>
                            </div>
                        </div>
                        
                        <div className={`flex justify-center mt-4 text-[10px] font-mono font-bold tracking-tight relative z-10 ${subTextColor}`}>
                            <span>ALL TIME {inputMetric.label.toUpperCase()} PER SET: <strong className={mainTextColor}>{stats.totalGoalsAllTime > 0 ? stats.ratio : 'X'}</strong></span>
                        </div>
                    </div>
                </div>
            );
        };

        const TrackerPill = ({ metric, count, onIncrement, onDecrement, theme }) => {
            return (
                <div className="w-full glass-card rounded-2xl p-1 pr-2 flex items-center justify-between mb-3 h-20 transition-all duration-300 hover:border-d2d-gold/30 hover:shadow-[0_0_20px_rgba(0,0,0,0.1)]">
                    
                    <div className="flex items-center flex-1 h-full pl-4 cursor-pointer group" onClick={onIncrement}>
                        <div className={`p-3 rounded-xl bg-gray-800/10 ${metric.color} shadow-inner border border-white/5 group-hover:scale-110 transition-transform duration-300`}>
                            {ICON_MAP[metric.icon] || <CheckCircle size={20} />}
                        </div>
                        <div className="ml-4 flex flex-col justify-center">
                            <span className="text-3xl font-bold text-white leading-none tracking-tight">{count}</span>
                            <span className={`text-[10px] font-bold uppercase tracking-wider mt-1 ${metric.color} opacity-70 group-hover:opacity-100 transition-opacity`}>
                                {metric.label}
                            </span>
                        </div>
                    </div>

                    <div className="flex items-center space-x-2 h-full py-2">
                        <button 
                            onClick={(e) => { e.stopPropagation(); onDecrement(); }}
                            className="h-full w-12 rounded-xl bg-gray-500/10 text-gray-500 hover:text-white hover:bg-gray-500/20 border border-transparent hover:border-white/10 transition-all active:scale-90 flex items-center justify-center"
                            aria-label="Subtract"
                        >
                            <Minus size={18} />
                        </button>
                        <button 
                            onClick={(e) => { e.stopPropagation(); onIncrement(); }}
                            className={`h-full w-16 rounded-xl ${metric.isGoal ? 'bg-gradient-to-b from-d2d-gold to-yellow-600 text-black shadow-[0_0_15px_rgba(245,158,11,0.4)]' : 'bg-gray-700/80 text-white border border-white/10'} hover:brightness-110 active:scale-95 transition-all flex items-center justify-center shadow-lg`}
                            aria-label="Add"
                        >
                            <Plus size={24} strokeWidth={3} />
                        </button>
                    </div>
                </div>
            );
        };

        const GamificationView = ({ state }) => {
            const stats = useMemo(() => {
                const { logs } = state;
                const uniqueDates = new Set();
                
                logs.forEach(log => {
                    if (log.value > 0) {
                        uniqueDates.add(getStartOfDay(log.timestamp).getTime());
                    }
                });

                const today = getStartOfDay(new Date()).getTime();
                
                let streak = 0;
                let checkDate = today;
                
                if (!uniqueDates.has(today)) {
                     checkDate -= 86400000; 
                }
                
                while (uniqueDates.has(checkDate)) {
                    streak++;
                    checkDate -= 86400000;
                }

                let daysWorked7 = 0;
                for(let i=0; i<7; i++) {
                    const d = today - (i * 86400000);
                    if(uniqueDates.has(d)) daysWorked7++;
                }
                const pct7 = Math.round((daysWorked7 / 7) * 100);

                let daysWorked30 = 0;
                for(let i=0; i<30; i++) {
                    const d = today - (i * 86400000);
                    if(uniqueDates.has(d)) daysWorked30++;
                }
                const pct30 = Math.round((daysWorked30 / 30) * 100);

                return { streak, pct7, pct30 };
            }, [state.logs]);

            const CircleProgress = ({ percentage, label, subLabel, color }) => (
                <div className="glass-card p-4 rounded-2xl flex flex-col items-center justify-center text-center relative overflow-hidden">
                    <div className="relative w-24 h-24 mb-2">
                         <svg className="w-full h-full transform -rotate-90">
                            <circle cx="48" cy="48" r="40" stroke="currentColor" strokeWidth="8" fill="transparent" className="text-gray-700/30" />
                            <circle 
                                cx="48" cy="48" r="40" 
                                stroke="currentColor" 
                                strokeWidth="8" 
                                fill="transparent" 
                                strokeDasharray={251.2} 
                                strokeDashoffset={251.2 - (251.2 * percentage) / 100} 
                                className={`${color} transition-all duration-1000 ease-out`}
                                strokeLinecap="round"
                            />
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <span className="text-xl font-bold text-white">{percentage}%</span>
                        </div>
                    </div>
                    <h3 className="text-sm font-bold text-white uppercase tracking-wider">{label}</h3>
                    <p className="text-[10px] text-gray-400 mt-1">{subLabel}</p>
                </div>
            );

            return (
                <div className="p-4 pb-32 animate-in fade-in duration-500">
                    <h2 className="text-2xl font-bold text-white mb-6 tracking-tight flex items-center gap-2">
                        <Trophy className="text-d2d-gold" />
                        Gamification
                    </h2>

                    <div className="glass-card rounded-2xl p-6 mb-6 text-center border-d2d-gold/30 bg-gradient-to-b from-d2d-gold/10 to-transparent">
                        <div className="inline-flex p-4 rounded-full bg-d2d-gold/20 mb-4 shadow-[0_0_30px_rgba(245,158,11,0.3)] animate-pulse-slow">
                            <Flame size={48} className="text-d2d-gold" fill="currentColor" />
                        </div>
                        <h3 className="text-5xl font-black text-white mb-1">{stats.streak}</h3>
                        <p className="text-d2d-gold font-bold uppercase tracking-widest text-sm">Daily Streak</p>
                        <p className="text-xs text-gray-400 mt-2">Keep the fire burning!</p>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <CircleProgress 
                            percentage={stats.pct7} 
                            label="Last 7 Days" 
                            subLabel="Consistency" 
                            color="text-blue-400" 
                        />
                        <CircleProgress 
                            percentage={stats.pct30} 
                            label="Last 30 Days" 
                            subLabel="Consistency" 
                            color="text-purple-400" 
                        />
                    </div>
                    
                    <div className="mt-8 text-center text-gray-500 text-xs italic">
                        "Success is the sum of small efforts, repeated day in and day out."
                    </div>
                </div>
            );
        };

        const StatsView = ({ state }) => {
            const [timeFrame, setTimeFrame] = useState('weekly');

            const chartData = useMemo(() => {
                const { logs, metrics } = state;
                const now = new Date();
                
                const isInRange = (timestamp) => {
                    const date = new Date(timestamp);
                    const nowStart = getStartOfDay(now);
                    const dateStart = getStartOfDay(date);

                    if (timeFrame === 'daily') {
                        return dateStart.getTime() === nowStart.getTime();
                    }
                    if (timeFrame === 'weekly') {
                        const startOfWeek = getStartOfWeek(now);
                        return date >= startOfWeek;
                    }
                    if (timeFrame === 'monthly') {
                        const startOfMonth = getStartOfMonth(now);
                        return date >= startOfMonth;
                    }
                    if (timeFrame === 'quarterly') {
                        const startOfQuarter = getStartOfQuarter(now);
                        return date >= startOfQuarter;
                    }
                    if (timeFrame === 'annual') {
                        const startOfYear = getStartOfYear(now);
                        return date >= startOfYear;
                    }
                    return false;
                };

                const filteredLogs = logs.filter(l => isInRange(l.timestamp));

                return metrics.map(m => {
                    const total = filteredLogs
                        .filter(l => l.metricId === m.id)
                        .reduce((acc, curr) => acc + curr.value, 0);
                    return {
                        name: m.label,
                        shortName: m.label.split(' ')[0],
                        value: total,
                        color: m.color.replace('text-', '')
                    };
                });

            }, [state, timeFrame]);

            const tabs = [
                { id: 'daily', label: 'Day' },
                { id: 'weekly', label: 'Week' },
                { id: 'monthly', label: 'Month' },
                { id: 'quarterly', label: 'Qtr' },
                { id: 'annual', label: 'Year' },
            ];

            return (
                <div className="p-4 pb-32 animate-in fade-in duration-500">
                    <h2 className="text-2xl font-bold text-white mb-6 tracking-tight flex items-center gap-2">
                        <BarChart2 className="text-blue-400" />
                        Stats
                    </h2>
                    
                    <div className="flex bg-gray-900/10 backdrop-blur-sm rounded-xl p-1 mb-6 overflow-x-auto no-scrollbar border border-white/5">
                        {tabs.map(t => (
                        <button
                            key={t.id}
                            onClick={() => setTimeFrame(t.id)}
                            className={`flex-1 py-2 px-3 text-xs font-bold uppercase tracking-wider rounded-lg whitespace-nowrap transition-all ${
                            timeFrame === t.id 
                            ? 'bg-d2d-gold text-black shadow-lg shadow-d2d-gold/20' 
                            : 'text-gray-400 hover:text-white hover:bg-white/5'
                            }`}
                        >
                            {t.label}
                        </button>
                        ))}
                    </div>

                    <div className="h-72 w-full glass-card rounded-2xl p-4 mb-6">
                        <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={chartData} layout="vertical" margin={{ left: -20, right: 10 }}>
                            <XAxis type="number" hide />
                            <YAxis 
                                dataKey="shortName" 
                                type="category" 
                                tick={{ fill: '#94a3b8', fontSize: 10, fontWeight: 600 }} 
                                width={60}
                                axisLine={false}
                                tickLine={false}
                            />
                            <Tooltip 
                                cursor={{fill: 'rgba(255,255,255,0.05)'}}
                                contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', borderRadius: '8px', color: '#fff', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.5)' }}
                                itemStyle={{ color: '#fff' }}
                            />
                            <Bar dataKey="value" radius={[0, 4, 4, 0]} barSize={24} animationDuration={1000}>
                                {chartData.map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={getColorHex(state.metrics[index].color)} />
                                ))}
                            </Bar>
                        </BarChart>
                        </ResponsiveContainer>
                    </div>

                    <div className="space-y-3">
                        {chartData.map((d, idx) => (
                            <div key={idx} className="flex justify-between items-center glass-card px-5 py-4 rounded-xl transition hover:bg-white/5">
                                <div className="flex items-center">
                                    <div className={`w-2 h-2 rounded-full mr-3 shadow-[0_0_8px_currentColor]`} style={{ backgroundColor: getColorHex(state.metrics[idx].color), color: getColorHex(state.metrics[idx].color) }}></div>
                                    <span className="text-gray-300 font-medium text-sm">{d.name}</span>
                                </div>
                                <span className="text-white font-bold font-mono text-lg">{d.value}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SettingsView = ({ state, onUpdateMetrics, onResetData }) => {
            const [pickingIconFor, setPickingIconFor] = useState(null);
            
            // Modal State
            const [modal, setModal] = useState({
                isOpen: false,
                title: '',
                message: '',
                onConfirm: null,
                type: 'confirm'
            });

            const availableIcons = Object.keys(ICON_MAP);

            // DIRECT UPDATE HANDLERS
            const handleLabelChange = (id, newLabel) => {
                const newMetrics = state.metrics.map(m => m.id === id ? { ...m, label: newLabel } : m);
                onUpdateMetrics(newMetrics);
            };

            const handleRoleChange = (id, role) => {
                const newMetrics = state.metrics.map(m => {
                    if (role === 'input') return { ...m, isInput: m.id === id };
                    else return { ...m, isGoal: m.id === id };
                });
                onUpdateMetrics(newMetrics);
            };

            const handleIconSelect = (metricId, iconKey) => {
                const newMetrics = state.metrics.map(m => m.id === metricId ? { ...m, icon: iconKey } : m);
                onUpdateMetrics(newMetrics);
                setPickingIconFor(null);
            };

            const handleAddMetric = () => {
                const newMetric = { 
                    id: `custom_${Date.now()}`, 
                    label: 'New Metric', 
                    icon: 'check-circle', 
                    color: 'text-gray-400',
                    isGoal: false, 
                    isInput: false 
                };
                onUpdateMetrics([...state.metrics, newMetric]);
            };

            const handleRemoveMetric = (id) => {
                if (state.metrics.length <= 1) {
                    setModal({
                        isOpen: true,
                        title: 'Action Denied',
                        message: 'You must have at least one metric configured.',
                        type: 'alert'
                    });
                    return;
                }
                
                setModal({
                    isOpen: true,
                    title: 'Delete Metric?',
                    message: 'Are you sure you want to remove this metric? This action cannot be undone.',
                    type: 'confirm',
                    onConfirm: () => {
                        const newMetrics = state.metrics.filter(m => m.id !== id);
                        onUpdateMetrics(newMetrics);
                    }
                });
            };

            const handleResetDefaults = () => {
                setModal({
                    isOpen: true,
                    title: 'Reset to Defaults?',
                    message: 'This will reset your buttons to the factory configuration. All custom buttons will be lost.',
                    type: 'confirm',
                    onConfirm: () => {
                        const defaults = JSON.parse(JSON.stringify(DEFAULT_METRICS));
                        onUpdateMetrics(defaults);
                    }
                });
            };

            const handleResetAllData = () => {
                setModal({
                    isOpen: true,
                    title: 'Reset All Data?',
                    message: 'Are you sure? This will delete ALL your tracked history. This cannot be undone.',
                    type: 'confirm',
                    onConfirm: onResetData
                });
            };

            const handleExport = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "d2d_data_" + new Date().toISOString().slice(0,10) + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            return (
                <div className="p-4 pb-32 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <h2 className="text-2xl font-bold text-white mb-2">Configuration</h2>
                    <p className="text-gray-400 text-sm mb-6">Changes are saved automatically.</p>

                    <div className="space-y-4">
                        <h3 className="text-white font-bold text-sm uppercase tracking-wider mb-2 mt-8">Metric Settings</h3>
                        {state.metrics.map((metric) => (
                        <div key={metric.id} className="glass-card p-3 rounded-xl transition-all duration-300">
                            
                            <div className="flex items-center gap-3 mb-3">
                                <button 
                                    type="button"
                                    onClick={() => setPickingIconFor(metric.id)}
                                    className="flex-shrink-0 p-3 bg-gray-800/10 rounded-lg text-d2d-gold border border-gray-700/50 hover:bg-d2d-gold/10 transition"
                                    title="Change Icon"
                                >
                                    {ICON_MAP[metric.icon] || ICON_MAP['check-circle']}
                                </button>

                                <input 
                                    type="text" 
                                    value={metric.label}
                                    onChange={(e) => handleLabelChange(metric.id, e.target.value)}
                                    className="flex-1 bg-gray-900/10 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-d2d-gold border border-white/5 min-w-0"
                                    placeholder="Metric Name"
                                />

                                <button 
                                    type="button"
                                    onClick={() => handleRemoveMetric(metric.id)}
                                    className="flex-shrink-0 p-3 text-gray-500 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition"
                                    title="Remove Metric"
                                >
                                    <Trash2 size={20} />
                                </button>
                            </div>
                            
                            <div className="flex gap-2 text-[10px] uppercase font-bold tracking-wide">
                                <button 
                                    type="button"
                                    onClick={() => handleRoleChange(metric.id, 'input')}
                                    className={`flex-1 py-2 rounded-lg border transition-all ${metric.isInput ? 'bg-blue-500/20 border-blue-500 text-blue-400 shadow-[0_0_10px_rgba(59,130,246,0.2)]' : 'border-gray-700/50 text-gray-500 hover:border-gray-600'}`}
                                >
                                    {metric.isInput ? 'MAIN INPUT' : 'Set as Input'}
                                </button>
                                <button 
                                    type="button"
                                    onClick={() => handleRoleChange(metric.id, 'goal')}
                                    className={`flex-1 py-2 rounded-lg border transition-all ${metric.isGoal ? 'bg-amber-500/20 border-amber-500 text-amber-400 shadow-[0_0_10px_rgba(245,158,11,0.2)]' : 'border-gray-700/50 text-gray-500 hover:border-gray-600'}`}
                                >
                                    {metric.isGoal ? 'MAIN GOAL' : 'Set as Goal'}
                                </button>
                            </div>
                        </div>
                        ))}
                    </div>

                    <button 
                        type="button"
                        onClick={handleAddMetric}
                        className="w-full mt-4 bg-gray-800/20 hover:bg-gray-700/30 border border-gray-700/50 border-dashed text-gray-400 font-medium py-4 rounded-xl flex items-center justify-center gap-2 transition hover:text-white"
                    >
                        <PlusCircle size={20} />
                        Add New Metric
                    </button>

                    <h3 className="text-white font-bold text-sm uppercase tracking-wider mb-2 mt-8">Data Management</h3>
                    <div className="space-y-3">
                        <button 
                            type="button"
                            onClick={handleResetDefaults}
                            className="w-full bg-transparent border border-gray-500 text-gray-500 hover:text-white hover:border-white font-medium py-4 rounded-xl flex items-center justify-center gap-2 transition"
                        >
                            <RefreshCw size={20} />
                            Reset Button Config
                        </button>

                        <button 
                            type="button"
                            onClick={handleExport}
                            className="w-full bg-blue-500/10 border border-blue-500/30 text-blue-400 hover:bg-blue-500/20 font-medium py-4 rounded-xl flex items-center justify-center gap-2 transition"
                        >
                            <Download size={20} />
                            Export Data
                        </button>

                        <button 
                            type="button"
                            onClick={handleResetAllData}
                            className="w-full bg-red-500/10 border border-red-500/30 text-red-400 hover:bg-red-500/20 font-medium py-4 rounded-xl flex items-center justify-center gap-2 transition"
                        >
                            <Trash2 size={20} />
                            Reset All Data
                        </button>
                    </div>

                    {/* Icon Picker Modal */}
                    {pickingIconFor && (
                        <div 
                            className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md p-6 animate-in fade-in duration-200"
                            onClick={() => setPickingIconFor(null)}
                        >
                            <div 
                                className="glass-panel rounded-2xl w-full max-w-sm max-h-[70vh] flex flex-col shadow-2xl border border-d2d-gold/20"
                                onClick={e => e.stopPropagation()}
                            >
                                <div className="flex justify-between items-center p-4 border-b border-white/10">
                                    <h3 className="text-white font-bold">Select Icon</h3>
                                    <button type="button" onClick={() => setPickingIconFor(null)} className="text-gray-400 hover:text-white">
                                        <X size={24} />
                                    </button>
                                </div>
                                <div className="p-4 overflow-y-auto grid grid-cols-4 gap-4 no-scrollbar">
                                    {availableIcons.map(iconKey => (
                                        <button 
                                            type="button"
                                            key={iconKey}
                                            onClick={() => handleIconSelect(pickingIconFor, iconKey)}
                                            className={`aspect-square flex items-center justify-center rounded-xl border transition-all ${
                                                state.metrics.find(m => m.id === pickingIconFor)?.icon === iconKey 
                                                ? 'bg-d2d-gold/20 border-d2d-gold text-d2d-gold shadow-[0_0_10px_rgba(245,158,11,0.2)]' 
                                                : 'border-white/5 bg-white/5 text-gray-400 hover:border-d2d-gold/50 hover:text-white'
                                            }`}
                                        >
                                            {ICON_MAP[iconKey]}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Confirmation/Alert Modal */}
                    <Modal 
                        isOpen={modal.isOpen} 
                        title={modal.title} 
                        message={modal.message} 
                        type={modal.type}
                        onClose={() => setModal(prev => ({ ...prev, isOpen: false }))}
                        onConfirm={modal.onConfirm}
                    />
                </div>
            );
        };

        const App = () => {
            const [state, setState] = useState({ metrics: [], logs: [], theme: 'dark' });
            const [currentView, setCurrentView] = useState('tracker');
            const [isLoaded, setIsLoaded] = useState(false);
            const [alertModal, setAlertModal] = useState(null);
            const [storageAlert, setStorageAlert] = useState(false);
            
            // Current Date Hook for resetting counts at midnight
            const [today, setToday] = useState(new Date());

            useEffect(() => {
                const data = getInitialState();
                setState(data);
                setIsLoaded(true);

                // Set up minute-based timer to refresh date
                const timer = setInterval(() => {
                    setToday(new Date());
                }, 60000);
                
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                if (isLoaded) {
                    const size = saveState(state);
                    if (state.theme === 'light') {
                        document.body.classList.add('light-mode');
                    } else {
                        document.body.classList.remove('light-mode');
                    }

                    // Check Storage limit
                    if (size > MAX_STORAGE_BYTES && !storageAlert) {
                        setStorageAlert(true);
                    }
                }
            }, [state, isLoaded, storageAlert]);

            const handleLog = (metricId, value, specificCoords = null, meta = null, timestamp = null) => {
                const logId = crypto.randomUUID();
                const newLog = { 
                    id: logId, 
                    timestamp: timestamp || Date.now(), 
                    metricId, 
                    value 
                };

                if (meta) newLog.meta = meta;
                
                if (specificCoords) {
                    newLog.lat = specificCoords.lat;
                    newLog.lng = specificCoords.lng;
                }

                // 1. Optimistic Update (Immediate)
                setState(prev => ({ ...prev, logs: [...prev.logs, newLog] }));

                // 2. Confetti (Immediate)
                if (value > 0) {
                    const metric = state.metrics.find(m => m.id === metricId);
                    if (metric && metric.isGoal) {
                        confetti({
                            particleCount: 150,
                            spread: 70,
                            origin: { y: 0.7 },
                            colors: ['#f59e0b', '#fbbf24', '#ffffff'] // Gold theme
                        });
                    }
                }

                // 3. Async GPS (Background) - ONLY if no specific coords provided (e.g. Dashboard button click)
                if (!specificCoords && "geolocation" in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            // Update the log we just added with coordinates
                            setState(prev => ({
                                ...prev,
                                logs: prev.logs.map(l => 
                                    l.id === logId 
                                    ? { ...l, lat: position.coords.latitude, lng: position.coords.longitude } 
                                    : l
                                )
                            }));
                        },
                        (error) => {
                            console.warn("GPS update failed", error);
                            // No action needed, log exists without coords
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                }
            };

            const handleUpdateLog = (logId, changes) => {
                setState(prev => ({
                    ...prev,
                    logs: prev.logs.map(log => log.id === logId ? { ...log, ...changes } : log)
                }));
            };

            const handleDeleteLog = (logId) => {
                setState(prev => ({
                    ...prev,
                    logs: prev.logs.filter(log => log.id !== logId)
                }));
            };

            const handleUpdateMetrics = (newMetrics) => {
                setState(prev => ({ ...prev, metrics: newMetrics }));
            };

            const handleResetData = () => {
                setState(prev => ({ ...prev, logs: [] }));
            };

            const handlePruneData = () => {
                // Keep the newest 70% of data
                const sorted = [...state.logs].sort((a,b) => b.timestamp - a.timestamp);
                const keepCount = Math.floor(sorted.length * 0.7);
                const keptLogs = sorted.slice(0, keepCount).reverse(); // Put back in chronological order if needed, but array order doesn't strictly matter
                
                setState(prev => ({ ...prev, logs: keptLogs }));
                setStorageAlert(false);
            };

            const toggleTheme = () => {
                setState(prev => ({ ...prev, theme: prev.theme === 'dark' ? 'light' : 'dark' }));
            };

            const checkConfigValidity = () => {
                const input = state.metrics.find(m => m.isInput);
                const goal = state.metrics.find(m => m.isGoal);
                
                if (!input) return { valid: false, error: "Please select a Main Input (e.g., Doors Knocked) before exiting." };
                if (!goal) return { valid: false, error: "Please select a Main Goal (e.g., Appointments Set) before exiting." };
                if (input.id === goal.id) return { valid: false, error: "Main Input and Main Goal cannot be the same metric." };
                
                return { valid: true };
            };

            const attemptNavigation = (view) => {
                // If leaving settings, check validity
                if (currentView === 'settings' && view !== 'settings') {
                    const check = checkConfigValidity();
                    if (!check.valid) {
                        setAlertModal(check.error);
                        return;
                    }
                }
                setCurrentView(view);
            };

            // Uses the 'today' state to ensure re-render at midnight
            const getTodayCount = (metricId) => {
                const dateStr = today.toDateString();
                return state.logs
                    .filter(l => l.metricId === metricId && new Date(l.timestamp).toDateString() === dateStr)
                    .reduce((acc, curr) => acc + curr.value, 0);
            };

            if (!isLoaded) return <div className="min-h-screen flex items-center justify-center text-d2d-gold animate-pulse font-mono">LOADING...</div>;

            return (
                <div className="h-screen w-screen flex flex-col bg-transparent overflow-hidden">
                    
                    {/* GLOBAL HEADER */}
                    <TopBar onHome={() => attemptNavigation('tracker')} />

                    <main className="flex-1 relative z-10 flex flex-col pt-[80px] pb-[80px] overflow-hidden">
                        <div className="flex-1 overflow-y-auto no-scrollbar h-full relative">
                            {/* KEEP MAP ALIVE: We use display:none to hide it instead of unmounting it */}
                            <div className="absolute inset-0 z-0" style={{ display: currentView === 'map' ? 'block' : 'none' }}>
                                <MapView 
                                    state={state} 
                                    onLog={handleLog} 
                                    onUpdateLog={handleUpdateLog} 
                                    onDeleteLog={handleDeleteLog} 
                                    theme={state.theme} 
                                    isVisible={currentView === 'map'} 
                                />
                            </div>

                            {/* OTHER VIEWS */}
                            {currentView === 'tracker' && (
                            <div className="p-4 space-y-2 animate-in fade-in slide-in-from-bottom-8 duration-500 max-w-md mx-auto relative z-10">
                                <DashboardHeader state={state} />
                                <div className="h-4"></div>
                                {state.metrics.map(metric => (
                                <TrackerPill 
                                    key={metric.id} 
                                    metric={metric} 
                                    count={getTodayCount(metric.id)} 
                                    onIncrement={() => handleLog(metric.id, 1)}
                                    onDecrement={() => handleLog(metric.id, -1)}
                                />
                                ))}
                                
                                <div className="text-center text-gray-500 text-[10px] mt-8 pb-4 uppercase tracking-widest font-bold opacity-50">
                                    DOMINATE YOUR DAY
                                </div>

                                {/* Theme Toggle Button */}
                                <div className="flex justify-center pb-8">
                                    <button 
                                        onClick={toggleTheme}
                                        className="flex items-center gap-2 bg-gray-800/10 hover:bg-gray-800/20 px-4 py-2 rounded-full border border-gray-700/20 transition-all text-xs font-bold text-gray-500 hover:text-d2d-gold"
                                    >
                                        {state.theme === 'dark' ? <Moon size={14} /> : <Sun size={14} />}
                                        <span>{state.theme === 'dark' ? 'DARK MODE' : 'LIGHT MODE'}</span>
                                    </button>
                                </div>
                            </div>
                            )}

                            {currentView === 'gamification' && <div className="max-w-md mx-auto relative z-10"><GamificationView state={state} /></div>}
                            
                            {currentView === 'stats' && <div className="max-w-md mx-auto relative z-10"><StatsView state={state} /></div>}
                            
                            {currentView === 'settings' && (
                                <div className="max-w-md mx-auto relative z-10">
                                    <SettingsView 
                                        state={state} 
                                        onUpdateMetrics={handleUpdateMetrics} 
                                        onResetData={handleResetData}
                                    />
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Navigation Blocked Alert */}
                    <Modal 
                        isOpen={!!alertModal} 
                        title="Configuration Error" 
                        message={alertModal} 
                        type="alert"
                        onClose={() => setAlertModal(null)}
                        onConfirm={() => setAlertModal(null)}
                    />

                    {/* Storage Warning */}
                    <Modal 
                        isOpen={storageAlert} 
                        title="Storage Full" 
                        message="Your device storage for this app is getting full. Would you like to clean up old data? This will keep your recent stats but delete older logs." 
                        type="prune"
                        onClose={() => setStorageAlert(false)}
                        onConfirm={handlePruneData}
                    />

                    {/* Bottom Navigation */}
                    <nav className="fixed bottom-0 left-0 right-0 z-50 h-[80px] glass-panel border-t border-d2d-glassBorder flex items-center justify-center safe-area-pb shadow-[0_-5px_20px_rgba(0,0,0,0.1)]">
                        <div className="w-full max-w-md grid grid-cols-5 gap-1 px-2">
                            <button 
                                onClick={() => attemptNavigation('tracker')}
                                className={`flex flex-col items-center justify-center p-3 rounded-2xl transition-all duration-300 ${currentView === 'tracker' ? 'text-d2d-gold bg-d2d-gold/10 scale-105 shadow-[0_0_15px_rgba(245,158,11,0.1)]' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                                <LayoutDashboard size={20} strokeWidth={currentView === 'tracker' ? 2.5 : 2} />
                            </button>

                            <button 
                                onClick={() => attemptNavigation('map')}
                                className={`flex flex-col items-center justify-center p-3 rounded-2xl transition-all duration-300 ${currentView === 'map' ? 'text-d2d-gold bg-d2d-gold/10 scale-105 shadow-[0_0_15px_rgba(245,158,11,0.1)]' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                                <MapIcon size={20} strokeWidth={currentView === 'map' ? 2.5 : 2} />
                            </button>
                            
                            <button 
                                onClick={() => attemptNavigation('gamification')}
                                className={`flex flex-col items-center justify-center p-3 rounded-2xl transition-all duration-300 ${currentView === 'gamification' ? 'text-d2d-gold bg-d2d-gold/10 scale-105 shadow-[0_0_15px_rgba(245,158,11,0.1)]' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                                <Trophy size={20} strokeWidth={currentView === 'gamification' ? 2.5 : 2} />
                            </button>

                            <button 
                                onClick={() => attemptNavigation('stats')}
                                className={`flex flex-col items-center justify-center p-3 rounded-2xl transition-all duration-300 ${currentView === 'stats' ? 'text-d2d-gold bg-d2d-gold/10 scale-105 shadow-[0_0_15px_rgba(245,158,11,0.1)]' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                                <BarChart2 size={20} strokeWidth={currentView === 'stats' ? 2.5 : 2} />
                            </button>
                            
                            <button 
                                onClick={() => attemptNavigation('settings')}
                                className={`flex flex-col items-center justify-center p-3 rounded-2xl transition-all duration-300 ${currentView === 'settings' ? 'text-d2d-gold bg-d2d-gold/10 scale-105 shadow-[0_0_15px_rgba(245,158,11,0.1)]' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                                <Settings size={20} strokeWidth={currentView === 'settings' ? 2.5 : 2} />
                            </button>
                        </div>
                    </nav>

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>