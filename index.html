<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <meta name="theme-color" content="#f0f9ff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="D2D Tracker" />
    
    <title>D2D Resources | Future Tracker</title>
    
    <!-- PWA Manifest (Data URI for single-file portability) -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiRDJEIFJlc291cmNlcyIs" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        d2d: {
                            navy: '#0f172a',
                            gold: '#f59e0b',
                            goldLight: '#fbbf24',
                            dark: '#020617',
                            glass: 'rgba(15, 23, 42, 0.6)',
                            glassBorder: 'rgba(255, 255, 255, 0.08)',
                        }
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <!-- Styles -->
    <style>
        :root {
            --bg-color: #000;
            --text-color: #f1f5f9;
            --glass-bg: rgba(15, 23, 42, 0.6);
            --glass-card-bg: rgba(30, 41, 59, 0.4);
            --glass-border: rgba(255, 255, 255, 0.08);
            --blob-color-1: #f59e0b;
            --blob-color-2: #1e3a8a;
            --blob-color-3: #4c1d95;
        }

        /* Light Mode Variables */
        body.light-mode {
            --bg-color: #f0f9ff;
            --text-color: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-card-bg: rgba(255, 255, 255, 0.5);
            --glass-border: rgba(0, 0, 0, 0.05);
            --blob-color-1: #fbbf24;
            --blob-color-2: #60a5fa;
            --blob-color-3: #a78bfa;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow-x: hidden;
            transition: background-color 0.5s ease, color 0.5s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Animated Background */
        .bg-ambient {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: var(--bg-color);
            overflow: hidden;
            transition: background 0.5s ease;
        }
        
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: blob 20s infinite alternate;
        }
        .orb-1 { top: 10%; left: 20%; width: 300px; height: 300px; background: var(--blob-color-1); animation-delay: 0s; }
        .orb-2 { top: 60%; left: 70%; width: 400px; height: 400px; background: var(--blob-color-2); animation-delay: -5s; }
        .orb-3 { top: 40%; left: 40%; width: 200px; height: 200px; background: var(--blob-color-3); animation-delay: -10s; }

        /* Glassmorphism Utils */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            transition: background 0.3s, border 0.3s;
        }
        
        .glass-card {
            background: var(--glass-card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            transition: background 0.3s, border 0.3s;
        }

        /* Light mode specific text overrides */
        body.light-mode .text-gray-400 { color: #64748b; }
        body.light-mode .text-gray-300 { color: #475569; }
        body.light-mode .text-gray-500 { color: #94a3b8; }
        body.light-mode .text-white { color: #0f172a; }

        /* Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Button active press effect */
        .btn-press:active { transform: scale(0.96); }
        
        /* Safe Area for iPhones */
        .safe-area-pb {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
    </style>

    <!-- Import Map for Modules -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
            "recharts": "https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0",
            "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
            "react/": "https://esm.sh/react@^19.2.3/"
        }
    }
    </script>
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>

    <!-- Background Elements -->
    <div class="bg-ambient">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
        <div class="orb orb-3"></div>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            DoorOpen, User, MessageCircle, ArrowRight, Calendar, DollarSign, 
            CheckCircle, XCircle, Zap, Sun, Moon, Home, Phone, Mail, TrendingUp, 
            Award, Smile, Frown, ThumbsUp, ThumbsDown, ClipboardList, Target, 
            LayoutDashboard, BarChart2, Settings, Key, Minus, Plus, Save, 
            RefreshCw, Trash2, PlusCircle, X, AlertTriangle, Check, Trophy, Flame
        } from 'lucide-react';
        import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell, PieChart, Pie } from 'recharts';

        // --- CONSTANTS ---
        const DEFAULT_METRICS = [
            { id: 'doors', label: 'Doors Knocked', icon: 'door', color: 'text-blue-400', isGoal: false, isInput: true },
            { id: 'dms', label: 'DMs Contacted', icon: 'user', color: 'text-indigo-400', isGoal: false, isInput: false },
            { id: 'pres', label: 'Door Presentation Complete', icon: 'message-circle', color: 'text-purple-400', isGoal: false, isInput: false },
            { id: 'trans', label: 'Transition Attempts', icon: 'arrow-right', color: 'text-pink-400', isGoal: false, isInput: false },
            { id: 'appt', label: 'Sets', icon: 'calendar', color: 'text-d2d-gold', isGoal: true, isInput: false },
        ];

        const ICON_MAP = {
            'door': <DoorOpen size={20} />,
            'user': <User size={20} />,
            'message-circle': <MessageCircle size={20} />,
            'arrow-right': <ArrowRight size={20} />,
            'calendar': <Calendar size={20} />,
            'dollar-sign': <DollarSign size={20} />,
            'check-circle': <CheckCircle size={20} />,
            'x-circle': <XCircle size={20} />,
            'zap': <Zap size={20} />,
            'sun': <Sun size={20} />,
            'home': <Home size={20} />,
            'phone': <Phone size={20} />,
            'mail': <Mail size={20} />,
            'trending-up': <TrendingUp size={20} />,
            'award': <Award size={20} />,
            'smile': <Smile size={20} />,
            'frown': <Frown size={20} />,
            'thumbs-up': <ThumbsUp size={20} />,
            'thumbs-down': <ThumbsDown size={20} />,
            'clipboard': <ClipboardList size={20} />,
            'target': <Target size={20} />
        };

        const INDUSTRY_AVERAGE_RATIO = 50;
        const STORAGE_KEY = 'd2d_resources_data_v2'; 

        // --- SERVICES ---
        const getInitialState = () => {
            try {
                let stored = localStorage.getItem(STORAGE_KEY);
                // Migration support
                if (!stored) stored = localStorage.getItem('d2d_resources_data_v1');

                if (stored) {
                    const parsed = JSON.parse(stored);
                    if (!parsed.metrics || parsed.metrics.length === 0) {
                        parsed.metrics = DEFAULT_METRICS;
                    }
                    if (!parsed.theme) parsed.theme = 'light'; // Default to light now
                    return parsed;
                }
            } catch (e) {
                console.error("Failed to load state", e);
            }
            return { metrics: DEFAULT_METRICS, logs: [], theme: 'light' }; // Default to light
        };

        const saveState = (state) => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.error("Failed to save state", e);
            }
        };

        // --- HELPER FUNCTIONS ---
        const getStartOfDay = (date) => {
            const d = new Date(date);
            d.setHours(0,0,0,0);
            return d;
        };

        const getStartOfWeek = (date) => {
            const d = new Date(date);
            const day = d.getDay(); 
            const diff = d.getDate() - day;
            d.setDate(diff);
            d.setHours(0,0,0,0);
            return d;
        };

        const getStartOfMonth = (date) => {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        };

        const getStartOfQuarter = (date) => {
            const q = Math.floor(date.getMonth() / 3);
            return new Date(date.getFullYear(), q * 3, 1);
        };

        const getStartOfYear = (date) => {
            return new Date(date.getFullYear(), 0, 1);
        };

        const makeSingular = (text) => {
            if (!text) return text;
            if (text.endsWith('s')) return text.slice(0, -1);
            return text;
        };

        const makePlural = (text) => {
            if (!text) return text;
            if (!text.endsWith('s')) return text + 's';
            return text;
        };

        // --- COMPONENTS ---

        const Modal = ({ isOpen, onClose, onConfirm, title, message, type = 'confirm' }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in duration-200 p-4">
                    <div className="glass-panel w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-d2d-gold/20 scale-100 animate-in zoom-in-95 duration-200">
                        <div className="flex items-start gap-4 mb-4">
                            <div className={`p-3 rounded-full ${type === 'confirm' ? 'bg-d2d-gold/10 text-d2d-gold' : 'bg-blue-500/10 text-blue-400'}`}>
                                {type === 'confirm' ? <AlertTriangle size={24} /> : <CheckCircle size={24} />}
                            </div>
                            <div>
                                <h3 className="text-xl font-bold text-white mb-1">{title}</h3>
                                <p className="text-gray-400 text-sm leading-relaxed">{message}</p>
                            </div>
                        </div>
                        
                        <div className="flex gap-3 justify-end mt-6">
                            {type === 'confirm' && (
                                <button 
                                    onClick={onClose}
                                    className="px-4 py-3 rounded-xl text-gray-400 hover:text-white hover:bg-white/10 transition font-medium text-sm"
                                >
                                    Cancel
                                </button>
                            )}
                            <button 
                                onClick={() => { if (onConfirm) onConfirm(); onClose(); }}
                                className="px-6 py-3 rounded-xl bg-d2d-gold text-black font-bold shadow-[0_0_15px_rgba(245,158,11,0.3)] hover:bg-yellow-400 transition text-sm active:scale-95"
                            >
                                {type === 'confirm' ? 'Confirm' : 'Got it'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardHeader = ({ state }) => {
            const { metrics, logs } = state;
            const inputMetric = metrics.find(m => m.isInput) || metrics[0] || { label: '?', id: '?' };
            const goalMetric = metrics.find(m => m.isGoal) || metrics[metrics.length - 1] || { label: '?', id: '?' };

            const stats = useMemo(() => {
                const totalInputs = logs.filter(l => l.metricId === inputMetric.id).reduce((acc, curr) => acc + curr.value, 0);
                const totalGoals = logs.filter(l => l.metricId === goalMetric.id).reduce((acc, curr) => acc + curr.value, 0);
                
                const rawRatio = totalGoals > 0 ? totalInputs / totalGoals : INDUSTRY_AVERAGE_RATIO;
                const ratio = Math.max(1, Math.round(rawRatio));

                const sortedLogs = [...logs].sort((a, b) => b.timestamp - a.timestamp);
                const lastGoalIndex = sortedLogs.findIndex(l => l.metricId === goalMetric.id && l.value > 0);
                
                const logsSinceGoal = lastGoalIndex === -1 ? sortedLogs : sortedLogs.slice(0, lastGoalIndex);
                
                const currentStreakInputs = logsSinceGoal
                    .filter(l => l.metricId === inputMetric.id)
                    .reduce((acc, curr) => acc + curr.value, 0);

                const remaining = Math.max(0, ratio - currentStreakInputs);
                const progressPercent = Math.min(100, (currentStreakInputs / ratio) * 100);

                return { ratio, currentStreakInputs, remaining, progressPercent };
            }, [logs, inputMetric.id, goalMetric.id]);

            // Formatting singular/plural logic for the input label in the remaining text
            const formattedInputLabel = stats.remaining === 1 ? makeSingular(inputMetric.label) : makePlural(inputMetric.label);
            
            // Formatting singular for the Goal label in the header title (e.g. "To Next Set" instead of "To Next Sets")
            const formattedGoalLabel = makeSingular(goalMetric.label);

            return (
                <div className="w-full glass-panel border-b border-d2d-glassBorder p-6 sticky top-0 z-20 shadow-2xl backdrop-blur-xl transition-colors duration-500">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <h1 className="text-xl font-black text-white tracking-widest uppercase transition-colors duration-500" style={{textShadow: '0 0 10px rgba(var(--bg-color), 0.3)'}}>D2D Resources</h1>
                            <p className="text-[10px] text-d2d-gold font-bold tracking-[0.2em] mt-1 uppercase">Keys to Success</p>
                        </div>
                        <div className="bg-d2d-gold/10 p-2 rounded-full border border-d2d-gold/30 shadow-[0_0_15px_rgba(245,158,11,0.2)]">
                            <Key className="text-d2d-gold" size={24} />
                        </div>
                    </div>

                    <div className="glass-card rounded-2xl p-4 relative overflow-hidden group">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-d2d-gold/5 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
                        
                        <div className="flex justify-between items-end mb-3 relative z-10">
                            <span className="text-gray-400 text-xs font-semibold uppercase tracking-wider">To Next {formattedGoalLabel}</span>
                            
                            <div className="text-right">
                                {stats.remaining <= 0 ? (
                                    <span className="text-lg font-bold text-d2d-gold tracking-tight animate-pulse">
                                        ANY DOOR NOW! <br/><span className="text-xs text-white">YOU'VE GOT THIS!</span>
                                    </span>
                                ) : (
                                    <span className="text-3xl font-bold text-white tracking-tight">
                                        {stats.remaining} <span className="text-sm font-normal text-gray-500 ml-1">{formattedInputLabel}</span>
                                    </span>
                                )}
                            </div>
                        </div>
                        
                        <div className="h-3 w-full bg-black/20 rounded-full overflow-hidden border border-white/5 relative shadow-inner">
                            <div 
                                className="h-full bg-gradient-to-r from-d2d-gold to-yellow-200 transition-all duration-700 ease-out relative shadow-[0_0_10px_rgba(245,158,11,0.5)]"
                                style={{ width: `${stats.progressPercent}%` }}
                            >
                                <div className="absolute inset-0 bg-white/30 animate-pulse"></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TrackerPill = ({ metric, count, onIncrement, onDecrement, theme }) => {
            return (
                <div className="w-full glass-card rounded-2xl p-1 pr-2 flex items-center justify-between mb-3 h-20 transition-all duration-300 hover:border-d2d-gold/30 hover:shadow-[0_0_20px_rgba(0,0,0,0.1)]">
                    
                    <div className="flex items-center flex-1 h-full pl-4 cursor-pointer group" onClick={onIncrement}>
                        <div className={`p-3 rounded-xl bg-gray-800/10 ${metric.color} shadow-inner border border-white/5 group-hover:scale-110 transition-transform duration-300`}>
                            {ICON_MAP[metric.icon] || <CheckCircle size={20} />}
                        </div>
                        <div className="ml-4 flex flex-col justify-center">
                            <span className="text-3xl font-bold text-white leading-none tracking-tight">{count}</span>
                            <span className={`text-[10px] font-bold uppercase tracking-wider mt-1 ${metric.color} opacity-70 group-hover:opacity-100 transition-opacity`}>
                                {metric.label}
                            </span>
                        </div>
                    </div>

                    <div className="flex items-center space-x-2 h-full py-2">
                        <button 
                            onClick={(e) => { e.stopPropagation(); onDecrement(); }}
                            className="h-full w-12 rounded-xl bg-gray-500/10 text-gray-500 hover:text-white hover:bg-gray-500/20 border border-transparent hover:border-white/10 transition-all active:scale-90 flex items-center justify-center"
                            aria-label="Subtract"
                        >
                            <Minus size={18} />
                        </button>
                        <button 
                            onClick={(e) => { e.stopPropagation(); onIncrement(); }}
                            className={`h-full w-16 rounded-xl ${metric.isGoal ? 'bg-gradient-to-b from-d2d-gold to-yellow-600 text-black shadow-[0_0_15px_rgba(245,158,11,0.4)]' : 'bg-gray-700/80 text-white border border-white/10'} hover:brightness-110 active:scale-95 transition-all flex items-center justify-center shadow-lg`}
                            aria-label="Add"
                        >
                            <Plus size={24} strokeWidth={3} />
                        </button>
                    </div>
                </div>
            );
        };

        const GamificationView = ({ state }) => {
            const stats = useMemo(() => {
                const { logs } = state;
                const uniqueDates = new Set();
                
                logs.forEach(log => {
                    if (log.value > 0) {
                        uniqueDates.add(getStartOfDay(log.timestamp).getTime());
                    }
                });

                const today = getStartOfDay(new Date()).getTime();
                
                let streak = 0;
                let checkDate = today;
                
                if (!uniqueDates.has(today)) {
                     checkDate -= 86400000; 
                }
                
                while (uniqueDates.has(checkDate)) {
                    streak++;
                    checkDate -= 86400000;
                }

                let daysWorked7 = 0;
                for(let i=0; i<7; i++) {
                    const d = today - (i * 86400000);
                    if(uniqueDates.has(d)) daysWorked7++;
                }
                const pct7 = Math.round((daysWorked7 / 7) * 100);

                let daysWorked30 = 0;
                for(let i=0; i<30; i++) {
                    const d = today - (i * 86400000);
                    if(uniqueDates.has(d)) daysWorked30++;
                }
                const pct30 = Math.round((daysWorked30 / 30) * 100);

                return { streak, pct7, pct30 };
            }, [state.logs]);

            const CircleProgress = ({ percentage, label, subLabel, color }) => (
                <div className="glass-card p-4 rounded-2xl flex flex-col items-center justify-center text-center relative overflow-hidden">
                    <div className="relative w-24 h-24 mb-2">
                         <svg className="w-full h-full transform -rotate-90">
                            <circle cx="48" cy="48" r="40" stroke="currentColor" strokeWidth="8" fill="transparent" className="text-gray-700/30" />
                            <circle 
                                cx="48" cy="48" r="40" 
                                stroke="currentColor" 
                                strokeWidth="8" 
                                fill="transparent" 
                                strokeDasharray={251.2} 
                                strokeDashoffset={251.2 - (251.2 * percentage) / 100} 
                                className={`${color} transition-all duration-1000 ease-out`}
                                strokeLinecap="round"
                            />
                        </svg>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <span className="text-xl font-bold text-white">{percentage}%</span>
                        </div>
                    </div>
                    <h3 className="text-sm font-bold text-white uppercase tracking-wider">{label}</h3>
                    <p className="text-[10px] text-gray-400 mt-1">{subLabel}</p>
                </div>
            );

            return (
                <div className="p-4 pb-32 animate-in fade-in duration-500">
                    <h2 className="text-2xl font-bold text-white mb-6 tracking-tight flex items-center gap-2">
                        <Trophy className="text-d2d-gold" />
                        Gamification
                    </h2>

                    <div className="glass-card rounded-2xl p-6 mb-6 text-center border-d2d-gold/30 bg-gradient-to-b from-d2d-gold/10 to-transparent">
                        <div className="inline-flex p-4 rounded-full bg-d2d-gold/20 mb-4 shadow-[0_0_30px_rgba(245,158,11,0.3)] animate-pulse-slow">
                            <Flame size={48} className="text-d2d-gold" fill="currentColor" />
                        </div>
                        <h3 className="text-5xl font-black text-white mb-1">{stats.streak}</h3>
                        <p className="text-d2d-gold font-bold uppercase tracking-widest text-sm">Daily Streak</p>
                        <p className="text-xs text-gray-400 mt-2">Keep the fire burning!</p>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <CircleProgress 
                            percentage={stats.pct7} 
                            label="Last 7 Days" 
                            subLabel="Consistency" 
                            color="text-blue-400" 
                        />
                        <CircleProgress 
                            percentage={stats.pct30} 
                            label="Last 30 Days" 
                            subLabel="Consistency" 
                            color="text-purple-400" 
                        />
                    </div>
                    
                    <div className="mt-8 text-center text-gray-500 text-xs italic">
                        "Success is the sum of small efforts, repeated day in and day out."
                    </div>
                </div>
            );
        };

        const StatsView = ({ state }) => {
            const [timeFrame, setTimeFrame] = useState('weekly');

            const chartData = useMemo(() => {
                const { logs, metrics } = state;
                const now = new Date();
                
                const isInRange = (timestamp) => {
                    const date = new Date(timestamp);
                    const nowStart = getStartOfDay(now);
                    const dateStart = getStartOfDay(date);

                    if (timeFrame === 'daily') {
                        return dateStart.getTime() === nowStart.getTime();
                    }
                    if (timeFrame === 'weekly') {
                        const startOfWeek = getStartOfWeek(now);
                        return date >= startOfWeek;
                    }
                    if (timeFrame === 'monthly') {
                        const startOfMonth = getStartOfMonth(now);
                        return date >= startOfMonth;
                    }
                    if (timeFrame === 'quarterly') {
                        const startOfQuarter = getStartOfQuarter(now);
                        return date >= startOfQuarter;
                    }
                    if (timeFrame === 'annual') {
                        const startOfYear = getStartOfYear(now);
                        return date >= startOfYear;
                    }
                    return false;
                };

                const filteredLogs = logs.filter(l => isInRange(l.timestamp));

                return metrics.map(m => {
                    const total = filteredLogs
                        .filter(l => l.metricId === m.id)
                        .reduce((acc, curr) => acc + curr.value, 0);
                    return {
                        name: m.label,
                        shortName: m.label.split(' ')[0],
                        value: total,
                        color: m.color.replace('text-', '')
                    };
                });

            }, [state, timeFrame]);

            const getColorHex = (tailwindClass) => {
                if (tailwindClass.includes('blue')) return '#60a5fa';
                if (tailwindClass.includes('indigo')) return '#818cf8';
                if (tailwindClass.includes('purple')) return '#c084fc';
                if (tailwindClass.includes('pink')) return '#f472b6';
                if (tailwindClass.includes('gold') || tailwindClass.includes('yellow')) return '#f59e0b';
                if (tailwindClass.includes('green')) return '#4ade80';
                if (tailwindClass.includes('red')) return '#f87171';
                return '#94a3b8';
            };

            const tabs = [
                { id: 'daily', label: 'Day' },
                { id: 'weekly', label: 'Week' },
                { id: 'monthly', label: 'Month' },
                { id: 'quarterly', label: 'Qtr' },
                { id: 'annual', label: 'Year' },
            ];

            return (
                <div className="p-4 pb-32 animate-in fade-in duration-500">
                    <h2 className="text-2xl font-bold text-white mb-6 tracking-tight flex items-center gap-2">
                        <BarChart2 className="text-blue-400" />
                        Stats
                    </h2>
                    
                    <div className="flex bg-gray-900/10 backdrop-blur-sm rounded-xl p-1 mb-6 overflow-x-auto no-scrollbar border border-white/5">
                        {tabs.map(t => (
                        <button
                            key={t.id}
                            onClick={() => setTimeFrame(t.id)}
                            className={`flex-1 py-2 px-3 text-xs font-bold uppercase tracking-wider rounded-lg whitespace-nowrap transition-all ${
                            timeFrame === t.id 
                            ? 'bg-d2d-gold text-black shadow-lg shadow-d2d-gold/20' 
                            : 'text-gray-400 hover:text-white hover:bg-white/5'
                            }`}
                        >
                            {t.label}
                        </button>
                        ))}
                    </div>

                    <div className="h-72 w-full glass-card rounded-2xl p-4 mb-6">
                        <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={chartData} layout="vertical" margin={{ left: -20, right: 10 }}>
                            <XAxis type="number" hide />
                            <YAxis 
                                dataKey="shortName" 
                                type="category" 
                                tick={{ fill: '#94a3b8', fontSize: 10, fontWeight: 600 }} 
                                width={60}
                                axisLine={false}
                                tickLine={false}
                            />
                            <Tooltip 
                                cursor={{fill: 'rgba(255,255,255,0.05)'}}
                                contentStyle={{ backgroundColor: '#0f172a', borderColor: '#334155', borderRadius: '8px', color: '#fff', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.5)' }}
                                itemStyle={{ color: '#fff' }}
                            />
                            <Bar dataKey="value" radius={[0, 4, 4, 0]} barSize={24} animationDuration={1000}>
                                {chartData.map((entry, index) => (
                                    <Cell key={`cell-${index}`} fill={getColorHex(state.metrics[index].color)} />
                                ))}
                            </Bar>
                        </BarChart>
                        </ResponsiveContainer>
                    </div>

                    <div className="space-y-3">
                        {chartData.map((d, idx) => (
                            <div key={idx} className="flex justify-between items-center glass-card px-5 py-4 rounded-xl transition hover:bg-white/5">
                                <div className="flex items-center">
                                    <div className={`w-2 h-2 rounded-full mr-3 shadow-[0_0_8px_currentColor]`} style={{ backgroundColor: getColorHex(state.metrics[idx].color), color: getColorHex(state.metrics[idx].color) }}></div>
                                    <span className="text-gray-300 font-medium text-sm">{d.name}</span>
                                </div>
                                <span className="text-white font-bold font-mono text-lg">{d.value}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const SettingsView = ({ state, onUpdateMetrics }) => {
            const [pickingIconFor, setPickingIconFor] = useState(null);
            
            // Modal State
            const [modal, setModal] = useState({
                isOpen: false,
                title: '',
                message: '',
                onConfirm: null,
                type: 'confirm'
            });

            const availableIcons = Object.keys(ICON_MAP);

            // DIRECT UPDATE HANDLERS
            const handleLabelChange = (id, newLabel) => {
                const newMetrics = state.metrics.map(m => m.id === id ? { ...m, label: newLabel } : m);
                onUpdateMetrics(newMetrics);
            };

            const handleRoleChange = (id, role) => {
                const newMetrics = state.metrics.map(m => {
                    if (role === 'input') return { ...m, isInput: m.id === id };
                    else return { ...m, isGoal: m.id === id };
                });
                onUpdateMetrics(newMetrics);
            };

            const handleIconSelect = (metricId, iconKey) => {
                const newMetrics = state.metrics.map(m => m.id === metricId ? { ...m, icon: iconKey } : m);
                onUpdateMetrics(newMetrics);
                setPickingIconFor(null);
            };

            const handleAddMetric = () => {
                const newMetric = { 
                    id: `custom_${Date.now()}`, 
                    label: 'New Metric', 
                    icon: 'check-circle', 
                    color: 'text-gray-400',
                    isGoal: false, 
                    isInput: false 
                };
                onUpdateMetrics([...state.metrics, newMetric]);
            };

            const handleRemoveMetric = (id) => {
                if (state.metrics.length <= 1) {
                    setModal({
                        isOpen: true,
                        title: 'Action Denied',
                        message: 'You must have at least one metric configured.',
                        type: 'alert'
                    });
                    return;
                }
                
                setModal({
                    isOpen: true,
                    title: 'Delete Metric?',
                    message: 'Are you sure you want to remove this metric? This action cannot be undone.',
                    type: 'confirm',
                    onConfirm: () => {
                        const newMetrics = state.metrics.filter(m => m.id !== id);
                        onUpdateMetrics(newMetrics);
                    }
                });
            };

            const handleResetDefaults = () => {
                setModal({
                    isOpen: true,
                    title: 'Reset to Defaults?',
                    message: 'This will reset your buttons to the factory configuration. All custom buttons will be lost.',
                    type: 'confirm',
                    onConfirm: () => {
                        const defaults = JSON.parse(JSON.stringify(DEFAULT_METRICS));
                        onUpdateMetrics(defaults);
                    }
                });
            };

            return (
                <div className="p-4 pb-32 animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <h2 className="text-2xl font-bold text-white mb-2">Configuration</h2>
                    <p className="text-gray-400 text-sm mb-6">Changes are saved automatically.</p>

                    <div className="space-y-4">
                        <h3 className="text-white font-bold text-sm uppercase tracking-wider mb-2 mt-8">Metric Settings</h3>
                        {state.metrics.map((metric) => (
                        <div key={metric.id} className="glass-card p-3 rounded-xl transition-all duration-300">
                            
                            <div className="flex items-center gap-3 mb-3">
                                <button 
                                    type="button"
                                    onClick={() => setPickingIconFor(metric.id)}
                                    className="flex-shrink-0 p-3 bg-gray-800/10 rounded-lg text-d2d-gold border border-gray-700/50 hover:bg-d2d-gold/10 transition"
                                    title="Change Icon"
                                >
                                    {ICON_MAP[metric.icon] || ICON_MAP['check-circle']}
                                </button>

                                <input 
                                    type="text" 
                                    value={metric.label}
                                    onChange={(e) => handleLabelChange(metric.id, e.target.value)}
                                    className="flex-1 bg-gray-900/10 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-d2d-gold border border-white/5 min-w-0"
                                    placeholder="Metric Name"
                                />

                                <button 
                                    type="button"
                                    onClick={() => handleRemoveMetric(metric.id)}
                                    className="flex-shrink-0 p-3 text-gray-500 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition"
                                    title="Remove Metric"
                                >
                                    <Trash2 size={20} />
                                </button>
                            </div>
                            
                            <div className="flex gap-2 text-[10px] uppercase font-bold tracking-wide">
                                <button 
                                    type="button"
                                    onClick={() => handleRoleChange(metric.id, 'input')}
                                    className={`flex-1 py-2 rounded-lg border transition-all ${metric.isInput ? 'bg-blue-500/20 border-blue-500 text-blue-400 shadow-[0_0_10px_rgba(59,130,246,0.2)]' : 'border-gray-700/50 text-gray-500 hover:border-gray-600'}`}
                                >
                                    {metric.isInput ? 'MAIN INPUT' : 'Set as Input'}
                                </button>
                                <button 
                                    type="button"
                                    onClick={() => handleRoleChange(metric.id, 'goal')}
                                    className={`flex-1 py-2 rounded-lg border transition-all ${metric.isGoal ? 'bg-amber-500/20 border-amber-500 text-amber-400 shadow-[0_0_10px_rgba(245,158,11,0.2)]' : 'border-gray-700/50 text-gray-500 hover:border-gray-600'}`}
                                >
                                    {metric.isGoal ? 'MAIN GOAL' : 'Set as Goal'}
                                </button>
                            </div>
                        </div>
                        ))}
                    </div>

                    <button 
                        type="button"
                        onClick={handleAddMetric}
                        className="w-full mt-4 bg-gray-800/20 hover:bg-gray-700/30 border border-gray-700/50 border-dashed text-gray-400 font-medium py-4 rounded-xl flex items-center justify-center gap-2 transition hover:text-white"
                    >
                        <PlusCircle size={20} />
                        Add New Metric
                    </button>

                    <div className="mt-8 space-y-3">
                        <button 
                            type="button"
                            onClick={handleResetDefaults}
                            className="w-full bg-transparent border border-gray-500 text-gray-500 hover:text-white hover:border-white font-medium py-4 rounded-xl flex items-center justify-center gap-2 transition"
                        >
                            <RefreshCw size={20} />
                            Reset to Defaults
                        </button>
                    </div>

                    {/* Icon Picker Modal */}
                    {pickingIconFor && (
                        <div 
                            className="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md p-6 animate-in fade-in duration-200"
                            onClick={() => setPickingIconFor(null)}
                        >
                            <div 
                                className="glass-panel rounded-2xl w-full max-w-sm max-h-[70vh] flex flex-col shadow-2xl border border-d2d-gold/20"
                                onClick={e => e.stopPropagation()}
                            >
                                <div className="flex justify-between items-center p-4 border-b border-white/10">
                                    <h3 className="text-white font-bold">Select Icon</h3>
                                    <button type="button" onClick={() => setPickingIconFor(null)} className="text-gray-400 hover:text-white">
                                        <X size={24} />
                                    </button>
                                </div>
                                <div className="p-4 overflow-y-auto grid grid-cols-4 gap-4 no-scrollbar">
                                    {availableIcons.map(iconKey => (
                                        <button 
                                            type="button"
                                            key={iconKey}
                                            onClick={() => handleIconSelect(pickingIconFor, iconKey)}
                                            className={`aspect-square flex items-center justify-center rounded-xl border transition-all ${
                                                state.metrics.find(m => m.id === pickingIconFor)?.icon === iconKey 
                                                ? 'bg-d2d-gold/20 border-d2d-gold text-d2d-gold shadow-[0_0_10px_rgba(245,158,11,0.2)]' 
                                                : 'border-white/5 bg-white/5 text-gray-400 hover:border-d2d-gold/50 hover:text-white'
                                            }`}
                                        >
                                            {ICON_MAP[iconKey]}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Confirmation/Alert Modal */}
                    <Modal 
                        isOpen={modal.isOpen} 
                        title={modal.title} 
                        message={modal.message} 
                        type={modal.type}
                        onClose={() => setModal(prev => ({ ...prev, isOpen: false }))}
                        onConfirm={modal.onConfirm}
                    />
                </div>
            );
        };

        const App = () => {
            const [state, setState] = useState({ metrics: [], logs: [], theme: 'light' });
            const [currentView, setCurrentView] = useState('tracker');
            const [isLoaded, setIsLoaded] = useState(false);
            const [alertModal, setAlertModal] = useState(null);

            useEffect(() => {
                const data = getInitialState();
                setState(data);
                setIsLoaded(true);
            }, []);

            useEffect(() => {
                if (isLoaded) {
                    saveState(state);
                    if (state.theme === 'light') {
                        document.body.classList.add('light-mode');
                    } else {
                        document.body.classList.remove('light-mode');
                    }
                }
            }, [state, isLoaded]);

            const handleLog = (metricId, value) => {
                const newLog = { 
                    id: crypto.randomUUID(), 
                    timestamp: Date.now(), 
                    metricId, 
                    value 
                };
                setState(prev => ({ ...prev, logs: [...prev.logs, newLog] }));
            };

            const handleUpdateMetrics = (newMetrics) => {
                setState(prev => ({ ...prev, metrics: newMetrics }));
            };

            const toggleTheme = () => {
                setState(prev => ({ ...prev, theme: prev.theme === 'dark' ? 'light' : 'dark' }));
            };

            const checkConfigValidity = () => {
                const input = state.metrics.find(m => m.isInput);
                const goal = state.metrics.find(m => m.isGoal);
                
                if (!input) return { valid: false, error: "Please select a Main Input (e.g., Doors Knocked) before exiting." };
                if (!goal) return { valid: false, error: "Please select a Main Goal (e.g., Appointments Set) before exiting." };
                if (input.id === goal.id) return { valid: false, error: "Main Input and Main Goal cannot be the same metric." };
                
                return { valid: true };
            };

            const attemptNavigation = (view) => {
                // If leaving settings, check validity
                if (currentView === 'settings' && view !== 'settings') {
                    const check = checkConfigValidity();
                    if (!check.valid) {
                        setAlertModal(check.error);
                        return;
                    }
                }
                setCurrentView(view);
            };

            const getTodayCount = (metricId) => {
                const today = new Date().toDateString();
                return state.logs
                    .filter(l => l.metricId === metricId && new Date(l.timestamp).toDateString() === today)
                    .reduce((acc, curr) => acc + curr.value, 0);
            };

            if (!isLoaded) return <div className="min-h-screen flex items-center justify-center text-d2d-gold animate-pulse font-mono">LOADING...</div>;

            return (
                <div className="min-h-screen flex flex-col max-w-md mx-auto relative overflow-hidden bg-transparent">
                    
                    {currentView === 'tracker' && <DashboardHeader state={state} />}

                    <main className="flex-1 overflow-y-auto no-scrollbar relative z-10">
                        {currentView === 'tracker' && (
                        <div className="p-4 pb-32 space-y-2 animate-in fade-in slide-in-from-bottom-8 duration-500">
                            {state.metrics.map(metric => (
                            <TrackerPill 
                                key={metric.id} 
                                metric={metric} 
                                count={getTodayCount(metric.id)} 
                                onIncrement={() => handleLog(metric.id, 1)}
                                onDecrement={() => handleLog(metric.id, -1)}
                            />
                            ))}
                            
                            <div className="text-center text-gray-500 text-[10px] mt-8 pb-4 uppercase tracking-widest font-bold opacity-50">
                                DOMINATE YOUR DAY
                            </div>

                            {/* Theme Toggle Button (Moved to bottom of Home Screen) */}
                            <div className="flex justify-center pb-8">
                                <button 
                                    onClick={toggleTheme}
                                    className="flex items-center gap-2 bg-gray-800/10 hover:bg-gray-800/20 px-4 py-2 rounded-full border border-gray-700/20 transition-all text-xs font-bold text-gray-500 hover:text-d2d-gold"
                                >
                                    {state.theme === 'dark' ? <Moon size={14} /> : <Sun size={14} />}
                                    <span>{state.theme === 'dark' ? 'DARK MODE' : 'LIGHT MODE'}</span>
                                </button>
                            </div>
                        </div>
                        )}

                        {currentView === 'gamification' && <GamificationView state={state} />}
                        
                        {currentView === 'stats' && <StatsView state={state} />}
                        
                        {currentView === 'settings' && (
                            <SettingsView 
                                state={state} 
                                onUpdateMetrics={handleUpdateMetrics} 
                            />
                        )}
                    </main>

                    {/* Navigation Blocked Alert */}
                    <Modal 
                        isOpen={!!alertModal} 
                        title="Configuration Error" 
                        message={alertModal} 
                        type="alert"
                        onClose={() => setAlertModal(null)}
                        onConfirm={() => setAlertModal(null)}
                    />

                    {/* Bottom Navigation */}
                    <nav className="fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-md z-50 glass-panel border-t border-d2d-glassBorder p-2 safe-area-pb shadow-[0_-5px_20px_rgba(0,0,0,0.1)]">
                        <div className="grid grid-cols-4 gap-1">
                            <button 
                                onClick={() => attemptNavigation('tracker')}
                                className={`flex flex-col items-center justify-center p-4 rounded-2xl transition-all duration-300 ${currentView === 'tracker' ? 'text-d2d-gold bg-d2d-gold/10 scale-105 shadow-[0_0_15px_rgba(245,158,11,0.1)]' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                                <LayoutDashboard size={24} strokeWidth={currentView === 'tracker' ? 2.5 : 2} />
                            </button>
                            
                            <button 
                                onClick={() => attemptNavigation('gamification')}
                                className={`flex flex-col items-center justify-center p-4 rounded-2xl transition-all duration-300 ${currentView === 'gamification' ? 'text-d2d-gold bg-d2d-gold/10 scale-105 shadow-[0_0_15px_rgba(245,158,11,0.1)]' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                                <Trophy size={24} strokeWidth={currentView === 'gamification' ? 2.5 : 2} />
                            </button>

                            <button 
                                onClick={() => attemptNavigation('stats')}
                                className={`flex flex-col items-center justify-center p-4 rounded-2xl transition-all duration-300 ${currentView === 'stats' ? 'text-d2d-gold bg-d2d-gold/10 scale-105 shadow-[0_0_15px_rgba(245,158,11,0.1)]' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                                <BarChart2 size={24} strokeWidth={currentView === 'stats' ? 2.5 : 2} />
                            </button>
                            
                            <button 
                                onClick={() => attemptNavigation('settings')}
                                className={`flex flex-col items-center justify-center p-4 rounded-2xl transition-all duration-300 ${currentView === 'settings' ? 'text-d2d-gold bg-d2d-gold/10 scale-105 shadow-[0_0_15px_rgba(245,158,11,0.1)]' : 'text-gray-500 hover:text-gray-300'}`}
                            >
                                <Settings size={24} strokeWidth={currentView === 'settings' ? 2.5 : 2} />
                            </button>
                        </div>
                    </nav>

                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
